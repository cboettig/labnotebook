<!DOCTYPE html>
<html lang="en" xmlns="https://www.w3.org/1999/xhtml" xml:lang="en">
  <head prefix="dc: https://purl.org/dc/terms/ og: https://ogp.me/ns#"> <!-- namespaces used in metadata.html -->
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
  <title>Gpdp Via Mdptoolbox Cont</title>
  <meta name="author" content="Carl Boettiger" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- HTML5 metadata -->
<meta name="keywords" content="gpmanagement, gp, nimble, mdptoolbox" />
<meta name="description" content="" />
<!-- RDFa Metadata (in DublinCore) -->
<meta property="dc:title" content="Gpdp Via Mdptoolbox Cont" />
<meta property="dc:creator" content="Carl Boettiger" />
<meta property="dc:date" content="2015-07-30 00:00:00 +0000" />
<meta property="dc:format" content="text/html" />
<meta property="dc:language" content="en" />
<meta property="dc:identifier" content="/07/30/gpdp-via-mdptoolbox-cont.html" />
<meta property="dc:rights" content="CC0" />
<meta property="dc:source" content="Lab Notebook" />
<meta property="dc:subject" content="Ecology" /> 
<meta property="dc:type" content="website" /> 
<!-- RDFa Metadata (in OpenGraph) -->
<meta property="og:title" content="Gpdp Via Mdptoolbox Cont" />
<meta property="og:author" content="https://www.carlboettiger.info/index.html#me" />  <!-- Should be Liquid? URI? -->
<meta property="https://ogp.me/ns/profile#first_name" content="Carl"/>
<meta property="https://ogp.me/ns/profile#last_name" content="Boettiger"/>
<meta property="https://ogp.me/ns/article#published_time" content="2015-07-30 00:00:00 +0000" />
<meta property="og:site_name" content="Lab Notebook" /> <!-- Same as dc:source? -->
<meta property="og:url" content="https://www.carlboettiger.info/07/30/gpdp-via-mdptoolbox-cont.html" />
<meta property="og:type" content="website" /> 
<!-- Google Scholar Metadata -->
<!--
<meta name="citation_author" content="Carl Boettiger"/>
<meta name="citation_date" content="2015-07-30 00:00:00 +0000"/>
<meta name="citation_title" content="Gpdp Via Mdptoolbox Cont"/>
<meta name="citation_journal_title" content="Lab Notebook"/>
-->
<!--NOTE: see also the COinS Metadata in span element in footer -->




	<link rel="stylesheet" href="https://www.carlboettiger.info/assets/css/bootstrap.min.css" type="text/css"/>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://www.carlboettiger.info/assets/css/academicons.css" />
  <!-- Help the browser identify the RSS feed automatically -->
  <link rel="alternate" type="application/rss+xml" title="Carl Boettiger's Lab Notebook" href="https://www.carlboettiger.info/blog.xml" />
</head>


  <body prefix="dc: https://purl.org/dc/terms/ foaf: https://xmlns.com/foaf/0.1/"> 
    <!-- Navbar  ================================================== -->

<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/README.html"><i class="icon-info-sign"></i></a>
    </div>

 <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

          <li  >
          <a href="/index.html">Home</a></li>
          <li  >
          <a href="/vita.html">Vita</a></li>
          <li  >
          <a href="/research.html">Research</a></li>
          <li  >
          <a href="/teaching.html">Teaching</a></li>
          <li  >
          <a href="/community.html">Community</a></li>
          <li  >
          <a href="/lab-notebook.html">Lab Notebook</a></li>

        </ul>

      <!-- Search site using Google's index -->
        <form class="navbar-form navbar-right" role="search" method="get" action="https://google.com/search">
          <div class="form-group">
            <input type="hidden" name="q" value="site:carlboettiger.info" />
            <input type="text" class="form-control search-query" name="q" placeholder="Search"/>
          </div>
          <button class="btn btn-mini" type="submit"><i class="icon-search"></i></button> 
       </form>

    </div><!--/.nav-collapse -->
  </div> <!-- /container -->
</nav>



    <div class="container"> <!-- Responsive grid layout, doesn't jump to full-width --> 
      <header>
        <h1 class="entry-title">Gpdp Via Mdptoolbox Cont</h1>
        <h2></h2>
      </header>

      <div class="row">
  <div class="col-md-7 col-md-offset-1">
    <article>
    <pre class="sourceCode r"><code class="sourceCode r">knitr::opts_chunk$<span class="kw">set</span>(<span class="dt">comment=</span><span class="ot">NA</span>)
<span class="co">#devtools::install_github(&quot;cboettig/gpmanagement@b3b765cbceb51c9b0b8cb2724e395353ec365df9&quot;)</span>
<span class="kw">library</span>(<span class="st">&quot;MDPtoolbox&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;gpmanagement&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;tidyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;lazyeval&quot;</span>)</code></pre>
<h3 id="true-model">True model</h3>
<pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">100</span>, <span class="dv">50</span>)
f &lt;-<span class="st"> </span>function (x, h){
  <span class="kw">sapply</span>(x, function(x) {
    x &lt;-<span class="st"> </span><span class="kw">pmax</span>(<span class="dv">0</span>, x -<span class="st"> </span>h)
    x *<span class="st"> </span><span class="kw">exp</span>(p[<span class="dv">1</span>] *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>x/p[<span class="dv">2</span>]) *<span class="st"> </span>(x -<span class="st"> </span>p[<span class="dv">3</span>])/p[<span class="dv">2</span>])
  })
}

sigma_g &lt;-<span class="st"> </span><span class="fl">0.1</span>
pdfn &lt;-<span class="st"> </span>function(x, mu, <span class="dt">sigma =</span> sigma_g){
  <span class="kw">dlnorm</span>(x, <span class="kw">log</span>(mu), <span class="dt">sdlog =</span> sigma)
}

z_g &lt;-<span class="st"> </span>function() <span class="kw">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_g)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">0</span>)
Tobs &lt;-<span class="st"> </span><span class="dv">40</span>

W &lt;-<span class="st"> </span>Tobs

x &lt;-<span class="st"> </span><span class="kw">numeric</span>(Tobs)
x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">60</span>
for(t in <span class="dv">1</span>:(Tobs<span class="dv">-1</span>))
  x[t<span class="dv">+1</span>] =<span class="st"> </span><span class="kw">z_g</span>() *<span class="st"> </span><span class="kw">f</span>(x[t], <span class="dt">h=</span><span class="dv">0</span>)
obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">0</span>, W), 
                        <span class="kw">pmax</span>(<span class="kw">rep</span>(<span class="dv">0</span>,Tobs<span class="dv">-1</span>), x[<span class="dv">1</span>:(Tobs<span class="dv">-1</span>)])), 
                  <span class="dt">y =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">0</span>, W), 
                        x[<span class="dv">2</span>:Tobs]))
xObs &lt;-<span class="st"> </span>obs$x
yObs &lt;-<span class="st"> </span>obs$y
xPred &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="kw">max</span>(xObs), <span class="dt">length =</span> <span class="dv">50</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(<span class="kw">seq_along</span>(x), x) +<span class="st"> </span><span class="kw">geom_line</span>()</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-4-1.png" />
</figure>
<pre class="sourceCode r"><code class="sourceCode r">xObs &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">5</span>)
yObs &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">5</span>)</code></pre>
<hr />
<p>Now the GP estimation from NIMBLE. Updated to compute the prior for the length scale using Danielâ€™s scaling argument.</p>
<pre class="sourceCode r"><code class="sourceCode r"> priors_template &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
        rho ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, X)
        sigGP ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
        sigOE ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
        })  

nimbleCodeSub &lt;-<span class="st"> </span>function(code, .values){
  <span class="kw">as.expression</span>(<span class="kw">sapply</span>(code, lazyeval::interp, <span class="dt">.values =</span> .values)[-<span class="dv">1</span>])
}
  
priors &lt;-<span class="st"> </span><span class="kw">nimbleCodeSub</span>(priors_template, 
                        <span class="dt">.values =</span> <span class="kw">list</span>(<span class="dt">X =</span> <span class="kw">diff</span>(<span class="kw">range</span>(xObs))/(<span class="dv">2</span>*<span class="kw">sqrt</span>(<span class="dv">6</span>))) )</code></pre>
<p>(Note that at this time all nimble run calls must be made in one block since we cannot cache nimble pointers).</p>
<pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">gp_setup</span>(xObs, yObs, xPred, <span class="dt">priors =</span> priors)</code></pre>
<pre><code>NaNs were detected in model variable: logProb_rho.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">## Fit the GP
<span class="kw">system.time</span>(fit$Cmcmc$<span class="kw">run</span>(<span class="dv">100000</span>))</code></pre>
<pre><code>   user  system elapsed 
  5.476   0.024   5.498 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r">samples &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(fit$Cmcmc$mvSamples)

## Perform prediction
<span class="kw">system.time</span>(fit$Cpred$<span class="kw">run</span>(samples))</code></pre>
<pre><code>   user  system elapsed 
  5.792   0.000   5.790 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r">## Extract variables for future use
E &lt;-<span class="st"> </span>fit$Cpred$<span class="kw">getE</span>()
C &lt;-<span class="st"> </span>fit$Cpred$<span class="kw">getC</span>()
samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(samples)</code></pre>
<p>Posteriors</p>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span>tidyr::<span class="kw">gather</span>(samples)
<span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-8-1.png" />
</figure>
<pre class="sourceCode r"><code class="sourceCode r">obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> xObs, <span class="dt">y =</span> yObs)
pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> xPred, <span class="dt">y =</span> E, <span class="dt">ymin =</span> E -<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C)), <span class="dt">ymax =</span> E +<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C)))
ggplot2::<span class="kw">ggplot</span>(pred) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x,<span class="dt">y =</span> y, <span class="dt">ymin =</span> ymin, <span class="dt">ymax =</span> ymax), <span class="dt">fill =</span> <span class="st">&quot;grey80&quot;</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y), <span class="dt">size=</span><span class="dv">1</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> obs, <span class="kw">aes</span>(x,y)) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> <span class="kw">data.frame</span>(<span class="dt">x =</span> xPred, <span class="dt">true =</span> <span class="kw">f</span>(xPred,<span class="dv">0</span>)), <span class="kw">aes</span>(x,true), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(<span class="kw">c</span>(xObs, xPred)), <span class="dt">ylim =</span> <span class="kw">range</span>(<span class="kw">c</span>(yObs,E))) +
<span class="st">  </span><span class="kw">theme_bw</span>() </code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-9-1.png" />
</figure>
<hr />
<h2 id="decision-theory">Decision theory</h2>
<pre class="sourceCode r"><code class="sourceCode r">states &lt;-<span class="st"> </span>xPred <span class="co"># Vector of all possible states</span>
actions &lt;-<span class="st"> </span>states <span class="co"># Vector of actions: harvest</span></code></pre>
<p>Letâ€™s consider a slight variation of the most trivial utility function: one which explicitly adds a cost to completely exhausting the stock (or reducing the stock by more than, say 95% in this case.) This should be somewhat similar to the impact of no discount rate.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Utility function</span>
discount =<span class="st"> </span><span class="fl">0.99</span>

<span class="co">#get_utility &lt;- function(x,h) pmin(x,h)</span>
<span class="co">#R &lt;- outer(states, actions, get_utility)</span>

R &lt;-<span class="st"> </span><span class="kw">sapply</span>(actions, function(h){
      <span class="kw">sapply</span>(states, function(x){
  if(h &lt;<span class="st"> </span><span class="fl">0.95</span> *<span class="st"> </span>x)
    h
  else 
     -<span class="st"> </span><span class="dv">1</span> *<span class="st"> </span><span class="kw">max</span>(states)
  })
})</code></pre>
<p>Implementing policy</p>
<pre class="sourceCode r"><code class="sourceCode r">z &lt;-<span class="st"> </span>function() <span class="kw">rlnorm</span>(<span class="dv">1</span>, <span class="dt">meanlog =</span> <span class="dv">0</span>, <span class="dt">sdlog =</span> sigma_g)

simulate_policy &lt;-<span class="st"> </span>function(states, actions, policy, f, z, s0, <span class="dt">steps =</span> <span class="dv">50</span>, <span class="dt">utility =</span> function(s,a) <span class="ot">NA</span>, <span class="dt">discount =</span> <span class="dv">1</span>){
  s &lt;-<span class="st"> </span><span class="kw">numeric</span>(steps)
  a &lt;-<span class="st"> </span><span class="kw">numeric</span>(steps)
  u &lt;-<span class="st"> </span><span class="kw">numeric</span>(steps)
  s[<span class="dv">1</span>] &lt;-<span class="st"> </span>s0
  for(t in <span class="dv">1</span>:(steps<span class="dv">-1</span>)){
    
    a[t] &lt;-<span class="st"> </span>actions[policy[<span class="kw">which.min</span>(<span class="kw">abs</span>(states -<span class="st"> </span>s[t]))]]
    s[t<span class="dv">+1</span>] &lt;-<span class="st"> </span><span class="kw">z</span>() *<span class="st"> </span><span class="kw">f</span>(s[t], a[t])
    u[t] &lt;-<span class="st"> </span><span class="kw">utility</span>(s[t], a[t]) *<span class="st"> </span>discount ^<span class="st"> </span>t
  }
  
  <span class="co"># Final action determined but not implemented</span>
  a[steps] &lt;-<span class="st"> </span>actions[policy[<span class="kw">which.min</span>(<span class="kw">abs</span>(states -<span class="st"> </span>s[t]))]]

  <span class="kw">data.frame</span>(<span class="dt">time =</span> <span class="dv">1</span>:steps, <span class="dt">state =</span> s, <span class="dt">action =</span> a, <span class="dt">utility =</span> u)
}</code></pre>
<h3 id="gp-model">GP model</h3>
<pre class="sourceCode r"><code class="sourceCode r">gp_matrix &lt;-<span class="st"> </span>function(states, actions, E, C){
  
  transition &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(states), <span class="kw">length</span>(actions)))
  K &lt;-<span class="st"> </span><span class="kw">length</span>(states)
  sigmas &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C))
  
  for (k in <span class="dv">1</span>:<span class="kw">length</span>(states)) {
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(actions)) {
      nextpop &lt;-<span class="st"> </span>E[k] -<span class="st"> </span>actions[i]
      if(nextpop &lt;=<span class="st"> </span><span class="dv">0</span>) {
        transition[k, , i] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>, K -<span class="st"> </span><span class="dv">1</span>))
      } else {
        transition[k, , i] &lt;-<span class="st"> </span><span class="kw">dnorm</span>(states, nextpop, sigmas[i]) /<span class="st"> </span><span class="kw">sum</span>(<span class="kw">dnorm</span>(states, nextpop, sigmas[i]))
      }
    }
  }
  transition
}

P_gp &lt;-<span class="st"> </span><span class="kw">gp_matrix</span>(states, actions, E, C)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mdp_check</span>(<span class="dt">P =</span> P_gp, <span class="dt">R =</span> R)</code></pre>
<pre><code>[1] &quot;&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gp &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(P_gp, R, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.00001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> <span class="kw">numeric</span>(<span class="kw">length</span>(states)))</code></pre>
<pre><code>[1] &quot;MDP Toolbox: iterations stopped, epsilon-optimal policy found&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="dt">stock =</span> states, <span class="dt">escapement =</span> states -<span class="st"> </span>actions[gp$policy])) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(stock, escapement)) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Population size&quot;</span>) +<span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Escapement&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-15-1.png" />
</figure>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data.frame</span>(<span class="dt">reps =</span> <span class="dv">1</span>:<span class="dv">50</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reps) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">simulate_policy</span>(states,actions, gp$policy, f, z, <span class="dt">s0 =</span> <span class="dv">100</span>, <span class="dt">steps =</span> <span class="dv">20</span>, <span class="dt">utility =</span> pmin, <span class="dt">discount =</span> discount)[<span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;utility&quot;</span>)]) -&gt;
<span class="st">  </span>sims 

<span class="kw">mean</span>(sims$utility)</code></pre>
<pre><code>[1] 4.751511</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sims) +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(time, state, <span class="dt">group =</span> reps), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="st">&quot;darkblue&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-17-1.png" />
</figure>
<h4 id="simulate-under-the-true-model">Simulate under the true model</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data.frame</span>(<span class="dt">reps =</span> <span class="dv">1</span>:<span class="dv">50</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reps) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">simulate_policy</span>(states, actions, gp$policy, f, z, <span class="dt">s0 =</span> <span class="dv">100</span>, <span class="dt">steps =</span> <span class="dv">20</span>, <span class="dt">utility =</span> pmin, <span class="dt">discount =</span> discount)[<span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;utility&quot;</span>)]) -&gt;
<span class="st">  </span>sims 

<span class="kw">mean</span>(sims$utility)</code></pre>
<pre><code>[1] 4.751511</code></pre>
<p>(Average utility is approximate here since it does not include penalty; since a function and not a matrix is requred by this function at this time.)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sims) +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(time, state, <span class="dt">group =</span> reps), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="st">&quot;darkblue&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-19-1.png" />
</figure>
<hr />
<h3 id="comparison-to-true-model">Comparison to true model</h3>
<pre class="sourceCode r"><code class="sourceCode r">P &lt;-<span class="st"> </span><span class="kw">transition_matrix</span>(states, actions, f, pdfn)
<span class="co">#get_utility &lt;- function(x,h) pmin(x,h)</span>
<span class="co">#R &lt;- outer(states, actions, get_utility)</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mdp_check</span>(<span class="dt">P =</span> P, <span class="dt">R =</span> R)</code></pre>
<pre><code>[1] &quot;&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">mdp &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(P, R, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> <span class="kw">numeric</span>(<span class="kw">length</span>(states)))</code></pre>
<pre><code>[1] &quot;MDP Toolbox: iterations stopped, epsilon-optimal policy found&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="dt">stock =</span> states, 
                  <span class="dt">escapement =</span> states -<span class="st"> </span>actions[gp$policy], 
                  <span class="dt">optimal_escapement =</span> states -<span class="st"> </span>actions[mdp$policy])) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(stock, escapement)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(stock, optimal_escapement), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">alpha=</span>.<span class="dv">4</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Population size&quot;</span>) +<span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Escapement&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-22-1.png" />
</figure>
<p>Note that the altered award structure has almost no effect on the optimal policy given the true model, other than to avoid harvesting directly to zero even when the stock cannot persist, due to the explicit penalty for doing so.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data.frame</span>(<span class="dt">reps =</span> <span class="dv">1</span>:<span class="dv">50</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reps) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">simulate_policy</span>(states,actions, mdp$policy, f, z, <span class="dt">s0 =</span> <span class="dv">100</span>, <span class="dt">steps =</span> <span class="dv">20</span>, <span class="dt">utility =</span> pmin, <span class="dt">discount =</span> discount)[<span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;utility&quot;</span>)]) -&gt;
<span class="st">  </span>sims 

<span class="kw">mean</span>(sims$utility)</code></pre>
<pre><code>[1] 10.19602</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sims) +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(time, state, <span class="dt">group =</span> reps), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="st">&quot;darkblue&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-24-1.png" />
</figure>

    </article>
  </div>
  <div class="col-md-4">
    <div class="sidebar">
      
<aside prefix="og:https://ogp.me/ns/article#">
  <p> <i class="icon-calendar"></i>
    <time datetime="2015-07-30 00:00:00 +0000" 
    property="dc:created">30 Jul 2015</time></p>
   

 <br />

  
	<p><a class="btn btn-default" rel="prev" href='/2015/07/29/mdptoolbox-allen-model.html'><i class="icon-chevron-left"></i> prev</a>
  
  
  <a class="btn btn-default" rel="next" href='/2015/08/03/a-drat-repository-for-ropensci.html'>next <i class="icon-chevron-right"></i></a></p>
  

  <br />

  <p> <a  onclick="recordOutboundLink(this, 'Outbound Links', 'history'); 
            return false;" 
          class="btn btn-default" 
          href="https://github.com/cboettig/2015/commits/master/_posts/_posts/2015-07-30-gpdp-via-mdptoolbox-cont.Rmd"><i class="icon-time"></i> history</a></p>

  <br />

  <p><i class="icon-list"></i> Posted in 
     
      <a rel="dc:subject" class="category" 
         href="/2015/categories.html#ecology">ecology</a>
    
    </p>

  <p> <i class="icon-tag"></i> tags: 
    
    <!-- https://schema.org/BlogPosting/keywords -->
    <a rel="og:tag" class="tag" 
			href="/2015/tags.html#gpmanagement">#gpmanagement</a>, 
    
    <!-- https://schema.org/BlogPosting/keywords -->
    <a rel="og:tag" class="tag" 
			href="/2015/tags.html#gp">#gp</a>, 
    
    <!-- https://schema.org/BlogPosting/keywords -->
    <a rel="og:tag" class="tag" 
			href="/2015/tags.html#nimble">#nimble</a>, 
    
    <!-- https://schema.org/BlogPosting/keywords -->
    <a rel="og:tag" class="tag" 
			href="/2015/tags.html#mdptoolbox">#mdptoolbox</a>
    </p>

  <br/>

  

  <br/>
  <p><small> <i class="icon-barcode"></i> SHA Hash: <a href="https://github.com/cboettig/2015/commit/70b284b452f822d7eb179026c8de2b4dee27e3e1/_posts/_posts/2015-07-30-gpdp-via-mdptoolbox-cont.Rmd"> 70b284b452f822d7eb179026c8de2b4dee27e3e1</a></small></p>
    
  <br/>
  

</aside>

    </div>
  </div>
</div>

      <!-- Disqus Comments -->
      <div class="row disqus">
        <div class="col-md-8">          
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'cboettig'; // required: replace example with your forum shortname
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
      </div>






      <footer class="footer">

<!--************** FOAF information to social networks ***************************** -->
  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="https://www.carlboettiger.info#me">
      <p>
          <script type="text/javascript" src="/assets/js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
      <!--
          <a rel="foaf:account" href="https://plus.google.com/" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'GPlus'); 
             return false;"><i class="fa fa-google-plus"></i></a>

          <a rel="foaf:account" href="https://www.mendeley.com/profiles/carl-boettiger" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Mendeley'); 
             return false;"><img src="/assets/img/icon-mendeley.png" /></a> 

           citations on google-scholar

           stackoverflow
      -->
      <a rel="foaf:weblog" type="application/atom+xml" href="/blog.xml"  
         class="showtooltip" title="RSS feeds for my blog-style entries. See the feed on my lab notebook (/atom.xml) to follow all entries instead." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    <!--**************** End social links **************************** -->


    <div class="col-md-4 col-md-offset-1 col-xs-4">
      <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="https://onsclaims.wikispaces.com/"><img src="/assets/img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="https://creativecommons.org/ns#license" href="https://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="/assets/img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>


  
<!-- COinS metadata (for citation managers like Zotero etc), goes in body text -->
  <span
      class="Z3988" 
      title="ctx_ver=Z39.88-2004
      &amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Adc
      &amp;rfr_id=info%3Asid%2Focoins.info%3Agenerator
      &amp;rft.title=Gpdp Via Mdptoolbox Cont
      &amp;rft.creator=Carl Boettiger
      &amp;rft.date=2015-07-30
      &amp;rft.language=EN
      &amp;rft.rights=CC0
      &amp;rft_id=https://www.carlboettiger.info/07/30/gpdp-via-mdptoolbox-cont.html">
  </span>


</footer>




          <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <!-- JQuery, used on a few pages (still?) -->
    <!-- <script type="text/javascript" src="/assets/js/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Equations using MathJax -->
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });       </script>
    <!-- Twitter Bootstrap Javascript -->
    <!--  <script src="/assets/js/bootstrap.min.js"></script> -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>


    

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-18401403-1']);
          _gaq.push(['_trackPageview']);
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
  </script>



<script type="text/javascript">
function recordOutboundLink(link, category, action) {
  try {
    var pageTracker=_gat._getTracker("UA-18401403-1");
    pageTracker._trackEvent(category, action);
    setTimeout('document.location = "' + link.href + '"', 100)
  }catch(err){}
}
</script>




    </div>
  </body>
</html>
   
