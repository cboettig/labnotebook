<!DOCTYPE html>
<html lang="en" xmlns="https://www.w3.org/1999/xhtml" xml:lang="en">
  <head prefix="dc: https://purl.org/dc/terms/ og: https://ogp.me/ns#"> <!-- namespaces used in metadata.html -->
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
  <title>Lab Notebook</title>
  <meta name="author" content="Carl Boettiger" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- HTML5 metadata -->
<meta name="keywords" content="" />
<meta name="description" content="" />
<!-- RDFa Metadata (in DublinCore) -->
<meta property="dc:title" content="Lab Notebook" />
<meta property="dc:creator" content="Carl Boettiger" />
<meta property="dc:date" content="" />
<meta property="dc:format" content="text/html" />
<meta property="dc:language" content="en" />
<meta property="dc:identifier" content="/lab-notebook" />
<meta property="dc:rights" content="CC0" />
<meta property="dc:source" content="Lab Notebook" />
<meta property="dc:subject" content="Ecology" /> 
<meta property="dc:type" content="website" /> 
<!-- RDFa Metadata (in OpenGraph) -->
<meta property="og:title" content="Lab Notebook" />
<meta property="og:author" content="https://www.carlboettiger.info/index.html#me" />  <!-- Should be Liquid? URI? -->
<meta property="https://ogp.me/ns/profile#first_name" content="Carl"/>
<meta property="https://ogp.me/ns/profile#last_name" content="Boettiger"/>
<meta property="https://ogp.me/ns/article#published_time" content="" />
<meta property="og:site_name" content="Lab Notebook" /> <!-- Same as dc:source? -->
<meta property="og:url" content="https://www.carlboettiger.info/lab-notebook" />
<meta property="og:type" content="website" /> 
<!-- Google Scholar Metadata -->
<!--
<meta name="citation_author" content="Carl Boettiger"/>
<meta name="citation_date" content=""/>
<meta name="citation_title" content="Lab Notebook"/>
<meta name="citation_journal_title" content="Lab Notebook"/>
-->
<!--NOTE: see also the COinS Metadata in span element in footer -->




	<link rel="stylesheet" href="https://www.carlboettiger.info/assets/css/bootstrap.min.css" type="text/css"/>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://www.carlboettiger.info/assets/css/academicons.css" />
  <!-- Help the browser identify the RSS feed automatically -->
  <link rel="alternate" type="application/rss+xml" title="Carl Boettiger's Lab Notebook" href="https://www.carlboettiger.info/blog.xml" />
</head>


  <body prefix="dc: https://purl.org/dc/terms/ foaf: https://xmlns.com/foaf/0.1/"> 
    <!-- Navbar  ================================================== -->

<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/README.html"><i class="icon-info-sign"></i></a>
    </div>

 <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

          <li  >
          <a href="/index.html">Home</a></li>
          <li  >
          <a href="/vita.html">Vita</a></li>
          <li  >
          <a href="/research.html">Research</a></li>
          <li  >
          <a href="/teaching.html">Teaching</a></li>
          <li  >
          <a href="/community.html">Community</a></li>
          <li  >
          <a href="/lab-notebook.html">Lab Notebook</a></li>

        </ul>

      <!-- Search site using Google's index -->
        <form class="navbar-form navbar-right" role="search" method="get" action="https://google.com/search">
          <div class="form-group">
            <input type="hidden" name="q" value="site:carlboettiger.info" />
            <input type="text" class="form-control search-query" name="q" placeholder="Search"/>
          </div>
          <button class="btn btn-mini" type="submit"><i class="icon-search"></i></button> 
       </form>

    </div><!--/.nav-collapse -->
  </div> <!-- /container -->
</nav>



    <div class="container"> <!-- Responsive grid layout, doesn't jump to full-width --> 
      <header>
        <h1 class="entry-title">Lab Notebook</h1>
        <h2>(<a href="https://www.carlboettiger.info/2012/09/28/Welcome-to-my-lab-notebook.html">Introduction</a>)</h2>
      </header>

      <div class="row postpreview">
  <div class="col-md-11 col-md-offset-1">
    <div class="row">
			<h4> <a href="/2015/atom.xml"
              onClick="recordOutboundLink(this,
              'Outbound Links', 'RSS'); return false;"
              style="color: inherit;"
              ><i class="icon-rss" ></i> Entries</a></h4>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/12/31/reflections-on-the-open-lab-notebook.html">Reflecting on five years of the open lab notebook</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 31 Dec 2015</p>

<article>
<div class="excerpt">
<p>I have been keeping an open lab notebook now since <a href="https://www.carlboettiger.info/2010/02/02/The-Lab-Notebook-Goes-Open-.html">February of 2010</a> <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>. Those years have seen 271, 301, 164, 136, 86 and 44 posts, respectively. The notebook started on <a href="https://openwetware.org/wiki/Lab_Notebook">OpenWetWare</a>, with code on (now defunct) Google Code (using svn!). <a href="https://www.carlboettiger.info/2010/10/21/spatial-warning-signals-power-etc.html">By October</a> of that year I had moved to a Wordpress.org platform running on DreamHost, with code moving to GitHub earlier that year. Wordpress meant my own domain name, control of layout and plugins, better mobile support, and perhaps most importantly, avoided the occasional day-long down-times I had seen on OpenWetWare. By the end of 2010 I had also cobbled together <a href="https://www.carlboettiger.info/2010/12/11/socialr-an-r-package-to-track-the-status-of-computations-with-social-network-tools.html">a system</a> in which my scripts committed themselves to GitHub and automatically posted figures the generated to <a href="https://www.flickr.com/photos/cboettig">flickr</a> that included the Git hash. <a href="https://cran.r-project.org/web/packages/knitr/index.html">Knitr</a> was first released to CRAN in January of 2012, and by March I announced a <a href="https://www.carlboettiger.info/2012/03/21/knitr-github-and-a-new-phase-for-the-lab-notebook.html">new phase</a> for my lab notebook focused on notes written with knitr markdown living on GitHub. For the first time, part of the daily research narrative lived not directly in the lab notebook itself (thus the decline in total notebook posts starting that year). Most of my posts in the first two years are much more journal like; reflecting on what I have been working on or reading earlier that day, describing some equation or graph, or muddling over a sticking point. Some of this remained in the notebook, particularly for work unconnected to code (thoughts on some literature, mathematical derivations, etc), but more migrated to knitr documents outside of the notebook. While knitr brought the code, results, and discussion elements closer together, it also often meant I was writing with less distance from the results, and so the text shifted towards more technical and less reflective content. Notebook entries became more brief and bullet pointed, though also punctuated by an increasing frequency of notebook entries that really were blog posts, aimed at an audience and sometimes drawing lengthy comment sections, primarily on topics related to open science and research workflow.</p>
<p>In May of 2012, I then shifted platforms again, this time <a href="https://www.carlboettiger.info/2012/05/01/Jekyll-vs-Wordpress.html">moving to Jekyll</a>, primarily for reasons of performance and cost (as detailed in that post). I have always experimented heavily with different features and technology connected to the lab notebook, and Jekyll also opened new possibilities. Meanwhile, it fit nicely into the git/markdown-centric workflow I had already adapted. This made it easy to turn knitr outputs into notebook entries, though I waffled back on forth on whether it was more natural to post such material in the relevant project repository in GitHub or directly into the notebook. The notebook remained the home for work not (yet) connected to a project, and for blog posts, and occasionally cross-posted material on a particular project, often capturing a key result. Meanwhile more of my other work became open – in particular, I began writing my manuscripts in public GitHub project repositories from the start, and also making greater use of GitHub issues in projects. The end of 2012 also saw me leave graduate school and begin a post-doc, luckily with advisers that were equally neutral to my open notebook habit.</p>
<p>The start of 2015 saw the next significant evolution in platform. Though still based on Jekyll, I first I broke up what had been growing into one rather large <code>labnotebook</code> repo on GitHub into separate repos by year. This left me with a more lightweight repository and freed me to experiment with infrastructure without breaking all my old posts. I <a href="https://www.carlboettiger.info/2015/01/01/notebook-maintenance-and-scaling.html">began writing</a> all posts directly in knitr’s <code>.Rmd</code> format, allowing the code to be run automatically when the site was published, rather than executing it locally and copying over a <code>.md</code> file into the notebook. That this was possible is thanks to my adoption of Docker (making the myriad dependencies portable), Continuous integration platforms that could run the code (using the Docker container) and automatically push the compiled site, and <code>servr</code>, another Yihui Xie R package that facilitates knitr+jekyll integration. Some entries involved particularly heavy computation, including a few that required several hours on a large Amazon EC2 machine to complete. <code>knitr</code>’s caching feature made it easy to snapshot these caches (which I did in a somewhat convoluted way with another docker container) so that the whole site could still be rebuilt on a public CI service (primarily circle-ci) within the 50 minute permitted window. The Docker+knitr+CI combination brought reproducible to a new level, though still not perfectly automated, since changing dependencies can still have some effect, particularly since I allow the container to be rebuilt from Dockerfile rather than committed as a binary image. I’ve been pleased that this system has worked remarkably well the entire year, though I’m frequently nervous that some piece of its increasingly complex architecture will break. Moreover, the complicated re-running of all the R code was increasingly redundant as most of my work continued to happen in GitHub repositories which had largely adopted their own system of continuous integration and unit testing (for basic functions and final results, if not for individual notebook posts).</p>
<p>More and more, GitHub, knitr, and other such tools have allowed me to actually perform my research openly, not just discuss it in an open notebook. Perhaps ironically, this means less and less content in the ‘lab notebook’ itself (as I <a href="https://www.carlboettiger.info/2012/09/28/Welcome-to-my-lab-notebook.html">wrote in 2012</a>, ‘the real notebook is on GitHub’). Interestingly, this has the side effect of making the ‘lab notebook’ much less visible. Living on my website, my open notebook has been hard to miss; a visitor could easily page through the entries to see what I had done recently without any of the familiarity it requires to navigate to the same material on GitHub. The idea that this was a scientist’s <em>notebook</em>, a concept both immediately familiar and yet so rarely public, perhaps gave it an out-sized significance to having the same material scattered around GitHub (some under my account and other work in various GitHub Organization accounts), where openness was already the norm. It attracted the attention of <a href="https://www.carlboettiger.info/vita#media-interviews">reporters</a> and, I’m told, my faculty search committee. So while I think <em>I</em> have benefited from this visibility, for the science it is perhaps much the same.</p>
<p>Halfway though 2015 also saw a different kind of change to my notebook as I transitioned from a post-doc to a faculty position. Just as my homepage (now maintained in its own GitHub repo, though still appearing in the same theme as my notebook) shifted from being “me” to being “my research group,” part of my time also shifted from “my research” to mentoring the research of others. While I continue to believe in transparency in scientific process and results, I have also appreciated that as a graduate student open science was something I was allowed to choose for myself. I want those I mentor to make their own choices as well. Thus we have begun projects with students primarily in private GitHub repositories (now hosted on <a href="https://github.com/boettiger-lab">github.com/boettiger-lab</a>).</p>
<p>So what does this mean for 2016 and the future of my open lab notebook? I suspect it will continue in its role as occasional blog and communication tool, where it’s greater visibility has a practical use, while becoming simpler technically, with the day-to-day of research (&amp; teaching, etc) activity confined to their own repositories.</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>though some material going back to <a href="https://www.carlboettiger.info/2000/lab-notebook">2009</a> and <a href="https://www.carlboettiger.info/2008/lab-notebook">2008</a> was posted later.<a href="#fnref1">↩</a></p></li>
</ol>
</section>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/12/31/reflections-on-the-open-lab-notebook.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/12/17/docker-workflows.html">Docker Workflows</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 17 Dec 2015</p>

<article>
<div class="excerpt">
<p>I was recently asked to describe what my typical workflow would look for running R on a cloud machine, such as digitalocean.<br />So, here’s a typical use:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">
<span class="co">## Create digitalocean machine</span>
<span class="kw">docker-machine</span> create --driver digitalocean --digitalocean-size 1gb --digitalocean-access-token <span class="ot">$DO_TOKEN</span> dev

<span class="co">## Point docker-engine at the the new machine</span>
<span class="kw">eval</span> <span class="ot">$(</span><span class="kw">docker-machine</span> env dev<span class="ot">)</span>

<span class="co">## Launch the Rocker container running RStudio</span>
<span class="kw">docker</span> run -d -p 8787:8787 -e PASSWORD=<span class="ot">$PASSWORD</span> rocker/hadleyverse

<span class="co">## Open browser at the IP address (e.g. mac-based terminal command)</span>
<span class="kw">open</span> https://<span class="ot">$(</span><span class="kw">docker-machine</span> ip dev<span class="ot">)</span>:8787</code></pre>
<p>From there, login with username “rstudio” and password you chose (will default to rstudio if nothing was given) and you’re good to go. RStudio has a nice git GUI which is a good way to move content on and off the instance, but I would also teach <code>docker commit</code> and <code>docker push</code> at the end as a way to capture the whole runtime (e.g. any packages installed, cached binaries from knitr, etc):</p>
<pre class="sourceCode bash"><code class="sourceCode bash">
<span class="kw">docker</span> commit <span class="kw">&lt;</span>hash<span class="kw">&gt;</span> username/myimage
<span class="kw">docker</span> push username/myimage </code></pre>
<p>(Using to the the private image slot if you don’t want your image &amp; results public)</p>
<p>It would probably be good to cover the non-interactive case too, which is helpful when you want to do a really long run of something that needs a bigger computer than your laptop. IMHO this is where docker-machine excels because it’s easy to have the machine shut down when all is finished! e.g.</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">## As before</span>
<span class="kw">docker-machine</span> create --driver digitalocean --digitalocean-size 1gb --digitalocean-access-token <span class="ot">$DO_TOKEN</span> dev
<span class="kw">eval</span> <span class="ot">$(</span><span class="kw">docker-machine</span> env dev<span class="ot">)</span>

<span class="co">## Let&#39;s use the committed image since it can already have my script included</span>
<span class="kw">docker</span> run --name batch username/myimage Rscript myscript.R

<span class="co">## commit using container name &amp; push back up</span>
<span class="kw">docker</span> commit batch username/myimage
<span class="kw">docker</span> push username/myimage 

<span class="co">## Script stops machine now</span>
<span class="kw">docker-machine</span> rm -f dev</code></pre>
<p>Clearly that can be modified to pull scripts down with git and push results back up to github rather than using docker commit to snapshot and push the whole image every time. Just add env vars for authentication.</p>
<p>Provided runs are &lt; 1 hr, this workflow can rather easily be applied to a continuous integration system such as Travis or Circle-CI, (which both support Docker), instead of using docker-machine to create a private cloud instance. This provides a very simple way to bring continuous integration testing and content (re)generation to individual research results.</p>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/12/17/docker-workflows.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/11/20/github-issues-import.html">Download and Parse Github Issues</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 20 Nov 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># devtools::install(&quot;cscheid/rgithub&quot;)</span>
<span class="kw">library</span>(<span class="st">&quot;github&quot;</span>)</code></pre>
<pre><code>Error in library(&quot;github&quot;): there is no package called &#39;github&#39;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;stringr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;lubridate&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;readr&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">ctx =<span class="st"> </span><span class="kw">interactive.login</span>(<span class="kw">Sys.getenv</span>(<span class="st">&quot;GH_CLIENT_ID&quot;</span>),<span class="kw">Sys.getenv</span>(<span class="st">&quot;GH_CLIENT_SECRET&quot;</span>))</code></pre>
<p>Thanks to @<a href="https://github.com/realAkhmed">realAkhmed</a> for this one, see: https://github.com/cscheid/rgithub/issues/30#issuecomment-150354560</p>
<pre class="sourceCode r"><code class="sourceCode r">auto.page &lt;-<span class="st"> </span>function(f) {
  f_call &lt;-<span class="st"> </span><span class="kw">substitute</span>(f)
  <span class="kw">stopifnot</span>(<span class="kw">is.call</span>(f_call))

  i &lt;-<span class="st"> </span><span class="dv">1</span>
  req &lt;-<span class="st"> </span><span class="kw">list</span>()
  result_lst &lt;-<span class="st"> </span><span class="kw">list</span>()

  repeat {
    <span class="co"># Specify the page to download</span>
    f_call$page &lt;-<span class="st"> </span>i

    req &lt;-<span class="st"> </span><span class="kw">eval</span>(f_call, <span class="kw">parent.frame</span>())

    <span class="co"># Last page has empty content</span>
    if (<span class="kw">length</span>(req$content)&lt;=<span class="dv">0</span>) break

    result_lst[[i]] &lt;-<span class="st"> </span>req$content
    i &lt;-<span class="st"> </span>i<span class="dv">+1</span>
  }

  result_req &lt;-<span class="st"> </span>req
  result_req$content &lt;-<span class="st"> </span><span class="kw">unlist</span>(result_lst, <span class="dt">recursive =</span> <span class="ot">FALSE</span>)

  (result_req)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">issues &lt;-<span class="st"> </span><span class="kw">auto.page</span>(github::<span class="kw">get.all.repository.issues.comments</span>(<span class="st">&quot;ropensci&quot;</span>, <span class="st">&quot;RNeXML&quot;</span>, <span class="dt">ctx=</span>ctx))
<span class="kw">length</span>(issues$content)</code></pre>
<p>Here we get the content of interest.</p>
<pre class="sourceCode r"><code class="sourceCode r">to_df &lt;-<span class="st"> </span>function(entry){
        dplyr::<span class="kw">data_frame</span>(
             <span class="dt">issue =</span> stringr::<span class="kw">str_replace</span>(entry$issue_url, <span class="st">&quot;.*/(.*$)&quot;</span>, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>), 
             <span class="dt">comment_id =</span> entry$id, 
             <span class="dt">user =</span> entry$user$login, 
             <span class="dt">created_at =</span> lubridate::<span class="kw">parse_date_time</span>(entry$created_at,<span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>),
             <span class="dt">updated_at =</span> lubridate::<span class="kw">parse_date_time</span>(entry$updated_at,<span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>),
             <span class="dt">body =</span> entry$body)
}</code></pre>
<p>Minor problem: This doesn’t actually include the issue’s title and opening comment (or tags, status, or other metadata that all come from the issues endpoint):</p>
<pre class="sourceCode r"><code class="sourceCode r">issue_meta &lt;-<span class="st"> </span><span class="kw">auto.page</span>(github::<span class="kw">get.repository.issues</span>(<span class="st">&quot;ropensci&quot;</span>, <span class="st">&quot;RNeXML&quot;</span>, <span class="dt">state=</span><span class="st">&quot;all&quot;</span>, <span class="dt">filter=</span><span class="st">&quot;all&quot;</span>, <span class="dt">ctx=</span>ctx))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">meta_to_df &lt;-<span class="st"> </span>function(entry){
        dplyr::<span class="kw">data_frame</span>(
             <span class="dt">issue =</span> stringr::<span class="kw">str_replace</span>(entry$html_url, <span class="st">&quot;.*/(.*$)&quot;</span>, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>), 
             <span class="dt">comment_id =</span> entry$id, 
             <span class="dt">user =</span> entry$user$login, 
             <span class="dt">state =</span> entry$state,
             <span class="dt">comments =</span> entry$comments,
             <span class="dt">created_at =</span> lubridate::<span class="kw">parse_date_time</span>(entry$created_at,<span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>),
             <span class="dt">updated_at =</span> lubridate::<span class="kw">parse_date_time</span>(entry$updated_at,<span class="st">&quot;%Y-%m-%d %H:%M:%S&quot;</span>),
             <span class="dt">title =</span> entry$title,
             <span class="dt">body =</span> entry$body)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span>dplyr::<span class="kw">bind_rows</span>(<span class="kw">lapply</span>(issues$content, to_df))
meta_df &lt;-<span class="st"> </span>dplyr::<span class="kw">bind_rows</span>(<span class="kw">lapply</span>(issue_meta$content, meta_to_df))
issue_tbl &lt;-<span class="st"> </span>dplyr::<span class="kw">full_join</span>(df, meta_df)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">readr::<span class="kw">write_csv</span>(issue_tbl, <span class="st">&quot;../_data/rnexml.csv&quot;</span>)</code></pre>
<p>Now let’s do <code>EML</code></p>
<pre class="sourceCode r"><code class="sourceCode r">issues &lt;-<span class="st"> </span><span class="kw">auto.page</span>(github::<span class="kw">get.all.repository.issues.comments</span>(<span class="st">&quot;ropensci&quot;</span>, <span class="st">&quot;EML&quot;</span>, <span class="dt">ctx=</span>ctx))
issue_meta &lt;-<span class="st"> </span><span class="kw">auto.page</span>(github::<span class="kw">get.repository.issues</span>(<span class="st">&quot;ropensci&quot;</span>, <span class="st">&quot;EML&quot;</span>, <span class="dt">state=</span><span class="st">&quot;all&quot;</span>, <span class="dt">filter=</span><span class="st">&quot;all&quot;</span>, <span class="dt">ctx=</span>ctx))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span>dplyr::<span class="kw">bind_rows</span>(<span class="kw">lapply</span>(issues$content, to_df))
meta_df &lt;-<span class="st"> </span>dplyr::<span class="kw">bind_rows</span>(<span class="kw">lapply</span>(issue_meta$content, meta_to_df))
issue_tbl &lt;-<span class="st"> </span>dplyr::<span class="kw">full_join</span>(df, meta_df)

readr::<span class="kw">write_csv</span>(issue_tbl, <span class="st">&quot;../_data/eml.csv&quot;</span>)</code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/11/20/github-issues-import.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

    <div class="row">
      
        <div class="col-md-3">
          <header><h4><a href="/2015/08/27/nimble-model-construction.html">Nimble Model Construction</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 27 Aug 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;nimble&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;lazyeval&quot;</span>)</code></pre>
<p>Can we declare the <code>nimbleCode</code> parts in sections? Such as defining the model and priors in separate, reusable code blocks? Here’s a “model” block:</p>
<pre class="sourceCode r"><code class="sourceCode r">model &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
  for (i in <span class="dv">1</span>:N){
    theta[i] ~<span class="st"> </span><span class="kw">dgamma</span>(alpha,beta)
    lambda[i] &lt;-<span class="st"> </span>theta[i]*t[i]
    x[i] ~<span class="st"> </span><span class="kw">dpois</span>(lambda[i])
  }
})</code></pre>
<p>We may also wish to define the priors separately, and with specified list of hyperparameters for the priors. Perhaps the need to use <code>quote</code> and to specify each line as a list item, instead of as a block defined with <code>{</code>, is not ideal, but non-standard evaluation is a bit of a wild west still.</p>
<pre class="sourceCode r"><code class="sourceCode r">hyperparameters &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">lambda =</span> <span class="fl">1.0</span>, <span class="dt">a =</span> <span class="fl">0.1</span>, <span class="dt">b =</span> <span class="fl">1.0</span>)

priors &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
  alpha ~<span class="st"> </span><span class="kw">dexp</span>(lambda)
  beta ~<span class="st"> </span><span class="kw">dgamma</span>(a,b)
})</code></pre>
<p>Having done so, we can construct a <code>nimbleCode</code> block by passing our chosen hyperparameters to the priors and concatenating the model and priors.</p>
<pre class="sourceCode r"><code class="sourceCode r">P &lt;-<span class="st"> </span><span class="kw">as.expression</span>(<span class="kw">sapply</span>(priors, lazyeval::interp, <span class="dt">.values =</span> hyperparameters)[-<span class="dv">1</span>])
pumpCode &lt;-<span class="st"> </span><span class="kw">c</span>(model, P)</code></pre>
<p>The result appears to work as a functional <code>nimbleCode</code> block; though note the resulting expression is not quite identical to the one we would typically write (e.g. without commas):</p>
<pre class="sourceCode r"><code class="sourceCode r">pumpCode</code></pre>
<pre><code>expression({
    for (i in 1:N) {
        theta[i] ~ dgamma(alpha, beta)
        lambda[i] &lt;- theta[i] * t[i]
        x[i] ~ dpois(lambda[i])
    }
}, alpha ~ dexp(1), beta ~ dgamma(0.1, 1))</code></pre>
<p>Here we just specify the rest of the model:</p>
<pre class="sourceCode r"><code class="sourceCode r">pumpConsts &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> <span class="dv">10</span>, 
                   <span class="dt">t =</span> <span class="kw">c</span>(<span class="fl">94.3</span>, <span class="fl">15.7</span>, <span class="fl">62.9</span>, <span class="dv">126</span>, <span class="fl">5.24</span>,
                         <span class="fl">31.4</span>, <span class="fl">1.05</span>, <span class="fl">1.05</span>, <span class="fl">2.1</span>, <span class="fl">10.5</span>))
pumpData &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">14</span>, <span class="dv">3</span>, <span class="dv">19</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">22</span>))
pumpInits &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>, 
                  <span class="dt">beta =</span> <span class="dv">1</span>,
                  <span class="dt">theta =</span> <span class="kw">rep</span>(<span class="fl">0.1</span>, pumpConsts$N))

pump &lt;-<span class="st"> </span><span class="kw">nimbleModel</span>(<span class="dt">code =</span> pumpCode, 
                    <span class="dt">name =</span> <span class="st">&#39;pump&#39;</span>, 
                    <span class="dt">constants =</span> pumpConsts,
                    <span class="dt">data =</span> pumpData, 
                    <span class="dt">inits =</span> pumpInits)</code></pre>
<p>and then verify that it runs.</p>
<pre class="sourceCode r"><code class="sourceCode r">Cmodel &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(pump)
mcmcspec &lt;-<span class="st"> </span><span class="kw">configureMCMC</span>(pump, <span class="dt">print=</span><span class="ot">FALSE</span>)
mcmc &lt;-<span class="st"> </span><span class="kw">buildMCMC</span>(mcmcspec)
Cmcmc &lt;-<span class="st"> </span><span class="kw">compileNimble</span>(mcmc, <span class="dt">project =</span> Cmodel)
Cmcmc$<span class="kw">run</span>(<span class="dv">1000</span>)</code></pre>
<pre><code>NULL</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">as.matrix</span>(Cmcmc$mvSamples))
<span class="kw">plot</span>(samples[ , <span class="st">&#39;alpha&#39;</span>], samples[ , <span class="st">&#39;beta&#39;</span>], <span class="dt">xlab =</span> <span class="kw">expression</span>(alpha), <span class="dt">ylab =</span> <span class="kw">expression</span>(beta))</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-08-27-nimble-model-construction/unnamed-chunk-7-1.png" />
</figure>
<p>(The plot shows the same correlation issue that arises without using a block sampler that is illustrated in the manual.)</p>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/08/27/nimble-model-construction.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/08/03/a-drat-repository-for-ropensci.html">a drat repository for rOpenSci (draft for ropensci blog)</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 03 Aug 2015</p>

<article>
<div class="excerpt">
<p>We’re happy to announce the launch of a CRAN-style repository for rOpenSci at <a href="https://packages.ropensci.org" class="uri">https://packages.ropensci.org</a></p>
<p>This repository contains the latest nightly builds from the master branch of all rOpenSci packages currently on GitHub. This allows users to install development versions of our software without specialized functions such as <code>install_github()</code>, allows dependencies not hosted on CRAN to still be resolved automatically, and permits the use of <code>update.packages()</code>.</p>
<h2 id="using-the-repository">Using the repository</h2>
<p>To use, simply add <code>packages.ropensci.org</code> to your existing list of R repos, such as:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">repos =</span> <span class="kw">c</span>(<span class="st">&quot;https://packages.ropensci.org&quot;</span>, <span class="kw">getOption</span>(<span class="st">&quot;repos&quot;</span>))</code></pre>
<p>(If you don’t have any default CRAN mirrors selected yet by <code>getOption(&quot;repos&quot;)</code>, you may want to add one now). You can also include this line in specific <code>install.packages()</code> requests:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;taxize&quot;</span>, <span class="dt">repos =</span> <span class="kw">c</span>(<span class="st">&quot;https://packages.ropensci.org&quot;</span>, <span class="st">&quot;https://cran.rstudio.com&quot;</span>))</code></pre>
<h2 id="design">Design</h2>
<p>Our goal in creating a CRAN-style package repository (yes, it’s confusing that we use the word “repository” to describe both an individual package source in a GitHub <em>repo</em> as well as a collection of package binaries on a CRAN-like <em>repo</em>… sorry) was to provide users with a way to install the latest development versions of rOpenSci packages that offerred an easier and more seamless alternative to the widely used method of <code>devtools::install_github()</code>. This would be particularly useful for updating all packages at once, or installing development versions that depended on other versions of packages not yet released to CRAN. As an added benefit, we also wanted a system that would allow us to compute anonmyzed download statistics, analogous to what RStudio provides for it’s CRAN mirror. Getting this all to work required the introduction of a few additional technologies.</p>
<h3 id="drat-and-drat.builder"><code>drat</code> and <code>drat.builder</code></h3>
<p>While the basic structure of a CRAN-like R repository is simple, used both platforms such as rForge as well as individual developers, kudos really goes to Dirk Eddelbuettel’s <a href="https://github.com/eddelbuettel/drat">drat</a> package for really making this automated, simple, and fun. While <code>drat</code> makes it easy to toss individual packages into a CRAN-like repo (which we often refer to as a <code>drat</code> repo), we needed an easy &amp; automatic way to add a whole list of packages, given their GitHub repos. Rich FitzJohn’s new <a href="https://github.com/richfitz/drat.builder">drat.builder</a> package does precisely this; handling the downloading of packages with some clever record-keeping to avoid building and adding packages which have not changed since the last time the <code>drat</code> repo was built. The sources for building the rOpenSci packages repository can be found in our “drat” GitHub repo: <a href="https://github.com/ropensci/drat" class="uri">https://github.com/ropensci/drat</a></p>
<h3 id="dynamic-package-lists-ropkgs">Dynamic package lists: <code>ropkgs</code></h3>
<p>With rOpenSci, we wanted to take this one step further. No one wants to have to maintain one more list that must be updated every time a package is successfully on-boarded to the project. Scott Chamberlain’s work with <a href="https://github.com/ropensci/ropkgs">ropkgs</a> provides a convenient way to query the rOpenSci software suite, automatically generating a list of available rOpenSci packages, and filtering them on relevant metadata, such as those that are in good status and installable condition, like so:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;ropkgs&quot;</span>)
out &lt;-<span class="st"> </span><span class="kw">ro_pkgs</span>()
good &lt;-<span class="st"> </span>out$packages$status ==<span class="st"> &quot;good&quot;</span>
installable &lt;-<span class="st"> </span>out$packages$installable
pkgs &lt;-<span class="st"> </span>out$packages$name[installable &amp;<span class="st"> </span>good]</code></pre>
<h3 id="the-magic-of-continuous-integration-circleci">the magic of continuous integration: CircleCI</h3>
<p>With <code>ropkgs</code>, <code>drat</code> and <code>drat.builder</code>, we now have everything we need to automate the building of the CRAN-like package repository. Now we just need some computing resource that can do the hard work of pulling down all the GitHub packages, building the repository, and securely sending off the binaries somewhere they can be downloaded. Continuous Integration systems turn out to be perfect for this. My favorite CI platform at the moment is <a href="https://circleci.com">CircleCi</a>, for several reasons particularly relevant here:</p>
<ul>
<li>it has a rich API which includes support for <code>POST</code> requests which can trigger a build without making commits to GitHub</li>
<li>it supports custom Docker containers, allowing us to just download a container with most or all the dependencies we need to build packages, etc., without having to wait for them to install manually from source first.</li>
<li>it has a convient web interface for providing secure credentials we’ll need to publish the binary repository to GitHub or Amazon.</li>
</ul>
<p>Circle has other advantages too, like great live help and the ability to ssh into your CI run to troubleshoot when all else fails, but otherwise works like most other CI platforms. More on that another day. You can see the daily builds here: <a href="https://circleci.com/gh/ropensci/drat/tree/gh-pages">CircleCi</a>, which are triggered by a simple <code>POST</code> request running as a cron job. The <a href="https://github.com/ropensci/drat/blob/gh-pages/circle.yml">circle.yml</a> configuration file appears in the project’s drat repo – check out how simple it is!</p>
<h3 id="publishing-to-amazon">Publishing to Amazon</h3>
<p>The last step would be getting download logs; which is somewhat more complicated than it sounds. <code>drat</code> convienently already handles pushing packages to GitHub’s gh-pages, a free and easy way to provide static hosting. This is free and easy, but isn’t ideal, particularly for large and frequently updated package collections. Also, it is impossible to get download logs from this approach. To avoid these issues, we settled on pushing our package repository to a static site hosted through Amazon’s S3 data storage “buckets.” It’s not free, but for at most a few gigs of space we’ll need it’s still very cost effective. In particular, S3 buckets can generate their own log files, which provides a way to count package downloads.</p>
<p>Secure communication with Amazon S3 system is accomplished using the very nacsent / actively developing <a href="https://github.com/cloudyr/aws.s3">aws.s3</a> R package from the awesome <a href="https://cloudyr.github.io/">cloudyr</a> project.</p>
<h3 id="parsing-the-download-logs">Parsing the download logs</h3>
<p>Amazon’s S3 logs are rather raw and require some good ol data tidying work to transform them into the conveniently parsed, tidied and IP-address-anonymized format used by RStudio’s download logs. Eventually this too can be accomplished by the CircleCI builds, but at the moment is too computationally intensive for them. A script for this workflow can be found in the project repo, <a href="https://github.com/ropensci/drat/blob/gh-pages/parse_s3_logs.R">parse_s3_logs.R</a>. As the data accumulate we should be able to start publishing the tidy logs.</p>
<p>This project is still in it’s early days, and as ever, we welcome feedback, problems or ideas on the <a href="https://github.com/ropensci/drat/issues">issues tracker</a>.</p>
<p>Now go ahead and install or update some packages from the shiny new <a href="https://packages.ropensci.org" class="uri">https://packages.ropensci.org</a>!</p>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/08/03/a-drat-repository-for-ropensci.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/07/30/gpdp-via-mdptoolbox-cont.html">Gpdp Via Mdptoolbox Cont</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 30 Jul 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r">knitr::opts_chunk$<span class="kw">set</span>(<span class="dt">comment=</span><span class="ot">NA</span>)
<span class="co">#devtools::install_github(&quot;cboettig/gpmanagement@b3b765cbceb51c9b0b8cb2724e395353ec365df9&quot;)</span>
<span class="kw">library</span>(<span class="st">&quot;MDPtoolbox&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;gpmanagement&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;tidyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;lazyeval&quot;</span>)</code></pre>
<h3 id="true-model">True model</h3>
<pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">100</span>, <span class="dv">50</span>)
f &lt;-<span class="st"> </span>function (x, h){
  <span class="kw">sapply</span>(x, function(x) {
    x &lt;-<span class="st"> </span><span class="kw">pmax</span>(<span class="dv">0</span>, x -<span class="st"> </span>h)
    x *<span class="st"> </span><span class="kw">exp</span>(p[<span class="dv">1</span>] *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>x/p[<span class="dv">2</span>]) *<span class="st"> </span>(x -<span class="st"> </span>p[<span class="dv">3</span>])/p[<span class="dv">2</span>])
  })
}

sigma_g &lt;-<span class="st"> </span><span class="fl">0.1</span>
pdfn &lt;-<span class="st"> </span>function(x, mu, <span class="dt">sigma =</span> sigma_g){
  <span class="kw">dlnorm</span>(x, <span class="kw">log</span>(mu), <span class="dt">sdlog =</span> sigma)
}

z_g &lt;-<span class="st"> </span>function() <span class="kw">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_g)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">0</span>)
Tobs &lt;-<span class="st"> </span><span class="dv">40</span>

W &lt;-<span class="st"> </span>Tobs

x &lt;-<span class="st"> </span><span class="kw">numeric</span>(Tobs)
x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">60</span>
for(t in <span class="dv">1</span>:(Tobs<span class="dv">-1</span>))
  x[t<span class="dv">+1</span>] =<span class="st"> </span><span class="kw">z_g</span>() *<span class="st"> </span><span class="kw">f</span>(x[t], <span class="dt">h=</span><span class="dv">0</span>)
obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">0</span>, W), 
                        <span class="kw">pmax</span>(<span class="kw">rep</span>(<span class="dv">0</span>,Tobs<span class="dv">-1</span>), x[<span class="dv">1</span>:(Tobs<span class="dv">-1</span>)])), 
                  <span class="dt">y =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">0</span>, W), 
                        x[<span class="dv">2</span>:Tobs]))
xObs &lt;-<span class="st"> </span>obs$x
yObs &lt;-<span class="st"> </span>obs$y
xPred &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="kw">max</span>(xObs), <span class="dt">length =</span> <span class="dv">50</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(<span class="kw">seq_along</span>(x), x) +<span class="st"> </span><span class="kw">geom_line</span>()</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-4-1.png" />
</figure>
<pre class="sourceCode r"><code class="sourceCode r">xObs &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">5</span>)
yObs &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">5</span>)</code></pre>
<hr />
<p>Now the GP estimation from NIMBLE. Updated to compute the prior for the length scale using Daniel’s scaling argument.</p>
<pre class="sourceCode r"><code class="sourceCode r"> priors_template &lt;-<span class="st"> </span><span class="kw">nimbleCode</span>({
        rho ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, X)
        sigGP ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
        sigOE ~<span class="st"> </span><span class="kw">dunif</span>(<span class="dv">0</span>, <span class="fl">1e5</span>)
        })  

nimbleCodeSub &lt;-<span class="st"> </span>function(code, .values){
  <span class="kw">as.expression</span>(<span class="kw">sapply</span>(code, lazyeval::interp, <span class="dt">.values =</span> .values)[-<span class="dv">1</span>])
}
  
priors &lt;-<span class="st"> </span><span class="kw">nimbleCodeSub</span>(priors_template, 
                        <span class="dt">.values =</span> <span class="kw">list</span>(<span class="dt">X =</span> <span class="kw">diff</span>(<span class="kw">range</span>(xObs))/(<span class="dv">2</span>*<span class="kw">sqrt</span>(<span class="dv">6</span>))) )</code></pre>
<p>(Note that at this time all nimble run calls must be made in one block since we cannot cache nimble pointers).</p>
<pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">gp_setup</span>(xObs, yObs, xPred, <span class="dt">priors =</span> priors)</code></pre>
<pre><code>NaNs were detected in model variable: logProb_rho.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">## Fit the GP
<span class="kw">system.time</span>(fit$Cmcmc$<span class="kw">run</span>(<span class="dv">100000</span>))</code></pre>
<pre><code>   user  system elapsed 
  5.476   0.024   5.498 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r">samples &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(fit$Cmcmc$mvSamples)

## Perform prediction
<span class="kw">system.time</span>(fit$Cpred$<span class="kw">run</span>(samples))</code></pre>
<pre><code>   user  system elapsed 
  5.792   0.000   5.790 </code></pre>
<pre class="sourceCode r"><code class="sourceCode r">## Extract variables for future use
E &lt;-<span class="st"> </span>fit$Cpred$<span class="kw">getE</span>()
C &lt;-<span class="st"> </span>fit$Cpred$<span class="kw">getC</span>()
samples &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(samples)</code></pre>
<p>Posteriors</p>
<pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span>tidyr::<span class="kw">gather</span>(samples)
<span class="kw">ggplot</span>(df) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">facet_wrap</span>(~key, <span class="dt">scale=</span><span class="st">&#39;free&#39;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-8-1.png" />
</figure>
<pre class="sourceCode r"><code class="sourceCode r">obs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> xObs, <span class="dt">y =</span> yObs)
pred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> xPred, <span class="dt">y =</span> E, <span class="dt">ymin =</span> E -<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C)), <span class="dt">ymax =</span> E +<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C)))
ggplot2::<span class="kw">ggplot</span>(pred) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x,<span class="dt">y =</span> y, <span class="dt">ymin =</span> ymin, <span class="dt">ymax =</span> ymax), <span class="dt">fill =</span> <span class="st">&quot;grey80&quot;</span>) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y), <span class="dt">size=</span><span class="dv">1</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> obs, <span class="kw">aes</span>(x,y)) +
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> <span class="kw">data.frame</span>(<span class="dt">x =</span> xPred, <span class="dt">true =</span> <span class="kw">f</span>(xPred,<span class="dv">0</span>)), <span class="kw">aes</span>(x,true), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(<span class="kw">c</span>(xObs, xPred)), <span class="dt">ylim =</span> <span class="kw">range</span>(<span class="kw">c</span>(yObs,E))) +
<span class="st">  </span><span class="kw">theme_bw</span>() </code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-9-1.png" />
</figure>
<hr />
<h2 id="decision-theory">Decision theory</h2>
<pre class="sourceCode r"><code class="sourceCode r">states &lt;-<span class="st"> </span>xPred <span class="co"># Vector of all possible states</span>
actions &lt;-<span class="st"> </span>states <span class="co"># Vector of actions: harvest</span></code></pre>
<p>Let’s consider a slight variation of the most trivial utility function: one which explicitly adds a cost to completely exhausting the stock (or reducing the stock by more than, say 95% in this case.) This should be somewhat similar to the impact of no discount rate.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Utility function</span>
discount =<span class="st"> </span><span class="fl">0.99</span>

<span class="co">#get_utility &lt;- function(x,h) pmin(x,h)</span>
<span class="co">#R &lt;- outer(states, actions, get_utility)</span>

R &lt;-<span class="st"> </span><span class="kw">sapply</span>(actions, function(h){
      <span class="kw">sapply</span>(states, function(x){
  if(h &lt;<span class="st"> </span><span class="fl">0.95</span> *<span class="st"> </span>x)
    h
  else 
     -<span class="st"> </span><span class="dv">1</span> *<span class="st"> </span><span class="kw">max</span>(states)
  })
})</code></pre>
<p>Implementing policy</p>
<pre class="sourceCode r"><code class="sourceCode r">z &lt;-<span class="st"> </span>function() <span class="kw">rlnorm</span>(<span class="dv">1</span>, <span class="dt">meanlog =</span> <span class="dv">0</span>, <span class="dt">sdlog =</span> sigma_g)

simulate_policy &lt;-<span class="st"> </span>function(states, actions, policy, f, z, s0, <span class="dt">steps =</span> <span class="dv">50</span>, <span class="dt">utility =</span> function(s,a) <span class="ot">NA</span>, <span class="dt">discount =</span> <span class="dv">1</span>){
  s &lt;-<span class="st"> </span><span class="kw">numeric</span>(steps)
  a &lt;-<span class="st"> </span><span class="kw">numeric</span>(steps)
  u &lt;-<span class="st"> </span><span class="kw">numeric</span>(steps)
  s[<span class="dv">1</span>] &lt;-<span class="st"> </span>s0
  for(t in <span class="dv">1</span>:(steps<span class="dv">-1</span>)){
    
    a[t] &lt;-<span class="st"> </span>actions[policy[<span class="kw">which.min</span>(<span class="kw">abs</span>(states -<span class="st"> </span>s[t]))]]
    s[t<span class="dv">+1</span>] &lt;-<span class="st"> </span><span class="kw">z</span>() *<span class="st"> </span><span class="kw">f</span>(s[t], a[t])
    u[t] &lt;-<span class="st"> </span><span class="kw">utility</span>(s[t], a[t]) *<span class="st"> </span>discount ^<span class="st"> </span>t
  }
  
  <span class="co"># Final action determined but not implemented</span>
  a[steps] &lt;-<span class="st"> </span>actions[policy[<span class="kw">which.min</span>(<span class="kw">abs</span>(states -<span class="st"> </span>s[t]))]]

  <span class="kw">data.frame</span>(<span class="dt">time =</span> <span class="dv">1</span>:steps, <span class="dt">state =</span> s, <span class="dt">action =</span> a, <span class="dt">utility =</span> u)
}</code></pre>
<h3 id="gp-model">GP model</h3>
<pre class="sourceCode r"><code class="sourceCode r">gp_matrix &lt;-<span class="st"> </span>function(states, actions, E, C){
  
  transition &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(states), <span class="kw">length</span>(actions)))
  K &lt;-<span class="st"> </span><span class="kw">length</span>(states)
  sigmas &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(C))
  
  for (k in <span class="dv">1</span>:<span class="kw">length</span>(states)) {
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(actions)) {
      nextpop &lt;-<span class="st"> </span>E[k] -<span class="st"> </span>actions[i]
      if(nextpop &lt;=<span class="st"> </span><span class="dv">0</span>) {
        transition[k, , i] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>, K -<span class="st"> </span><span class="dv">1</span>))
      } else {
        transition[k, , i] &lt;-<span class="st"> </span><span class="kw">dnorm</span>(states, nextpop, sigmas[i]) /<span class="st"> </span><span class="kw">sum</span>(<span class="kw">dnorm</span>(states, nextpop, sigmas[i]))
      }
    }
  }
  transition
}

P_gp &lt;-<span class="st"> </span><span class="kw">gp_matrix</span>(states, actions, E, C)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mdp_check</span>(<span class="dt">P =</span> P_gp, <span class="dt">R =</span> R)</code></pre>
<pre><code>[1] &quot;&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gp &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(P_gp, R, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.00001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> <span class="kw">numeric</span>(<span class="kw">length</span>(states)))</code></pre>
<pre><code>[1] &quot;MDP Toolbox: iterations stopped, epsilon-optimal policy found&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="dt">stock =</span> states, <span class="dt">escapement =</span> states -<span class="st"> </span>actions[gp$policy])) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(stock, escapement)) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Population size&quot;</span>) +<span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Escapement&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-15-1.png" />
</figure>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data.frame</span>(<span class="dt">reps =</span> <span class="dv">1</span>:<span class="dv">50</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reps) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">simulate_policy</span>(states,actions, gp$policy, f, z, <span class="dt">s0 =</span> <span class="dv">100</span>, <span class="dt">steps =</span> <span class="dv">20</span>, <span class="dt">utility =</span> pmin, <span class="dt">discount =</span> discount)[<span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;utility&quot;</span>)]) -&gt;
<span class="st">  </span>sims 

<span class="kw">mean</span>(sims$utility)</code></pre>
<pre><code>[1] 4.751511</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sims) +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(time, state, <span class="dt">group =</span> reps), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="st">&quot;darkblue&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-17-1.png" />
</figure>
<h4 id="simulate-under-the-true-model">Simulate under the true model</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data.frame</span>(<span class="dt">reps =</span> <span class="dv">1</span>:<span class="dv">50</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reps) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">simulate_policy</span>(states, actions, gp$policy, f, z, <span class="dt">s0 =</span> <span class="dv">100</span>, <span class="dt">steps =</span> <span class="dv">20</span>, <span class="dt">utility =</span> pmin, <span class="dt">discount =</span> discount)[<span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;utility&quot;</span>)]) -&gt;
<span class="st">  </span>sims 

<span class="kw">mean</span>(sims$utility)</code></pre>
<pre><code>[1] 4.751511</code></pre>
<p>(Average utility is approximate here since it does not include penalty; since a function and not a matrix is requred by this function at this time.)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sims) +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(time, state, <span class="dt">group =</span> reps), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="st">&quot;darkblue&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-19-1.png" />
</figure>
<hr />
<h3 id="comparison-to-true-model">Comparison to true model</h3>
<pre class="sourceCode r"><code class="sourceCode r">P &lt;-<span class="st"> </span><span class="kw">transition_matrix</span>(states, actions, f, pdfn)
<span class="co">#get_utility &lt;- function(x,h) pmin(x,h)</span>
<span class="co">#R &lt;- outer(states, actions, get_utility)</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mdp_check</span>(<span class="dt">P =</span> P, <span class="dt">R =</span> R)</code></pre>
<pre><code>[1] &quot;&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">mdp &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(P, R, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> <span class="kw">numeric</span>(<span class="kw">length</span>(states)))</code></pre>
<pre><code>[1] &quot;MDP Toolbox: iterations stopped, epsilon-optimal policy found&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="dt">stock =</span> states, 
                  <span class="dt">escapement =</span> states -<span class="st"> </span>actions[gp$policy], 
                  <span class="dt">optimal_escapement =</span> states -<span class="st"> </span>actions[mdp$policy])) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(stock, escapement)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(stock, optimal_escapement), <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">alpha=</span>.<span class="dv">4</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Population size&quot;</span>) +<span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Escapement&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-22-1.png" />
</figure>
<p>Note that the altered award structure has almost no effect on the optimal policy given the true model, other than to avoid harvesting directly to zero even when the stock cannot persist, due to the explicit penalty for doing so.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data.frame</span>(<span class="dt">reps =</span> <span class="dv">1</span>:<span class="dv">50</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reps) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">simulate_policy</span>(states,actions, mdp$policy, f, z, <span class="dt">s0 =</span> <span class="dv">100</span>, <span class="dt">steps =</span> <span class="dv">20</span>, <span class="dt">utility =</span> pmin, <span class="dt">discount =</span> discount)[<span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;utility&quot;</span>)]) -&gt;
<span class="st">  </span>sims 

<span class="kw">mean</span>(sims$utility)</code></pre>
<pre><code>[1] 10.19602</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sims) +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(time, state, <span class="dt">group =</span> reps), <span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="st">&quot;darkblue&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-30-gpdp-via-mdptoolbox-cont/unnamed-chunk-24-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/07/30/gpdp-via-mdptoolbox-cont.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

    <div class="row">
      
        <div class="col-md-3">
          <header><h4><a href="/2015/07/29/mdptoolbox-allen-model.html">Mdptoolbox Allen Model</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 29 Jul 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;MDPtoolbox&quot;</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)
<span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">K &lt;-<span class="st"> </span><span class="dv">150</span> <span class="co"># state space limit</span>
states &lt;-<span class="st"> </span><span class="dv">0</span>:K <span class="co"># Vector of all possible states</span>
actions &lt;-<span class="st"> </span>states <span class="co"># Vector of actions: harvest</span>


sigma_g =<span class="st"> </span><span class="fl">0.1</span>
p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">100</span>, <span class="dv">50</span>)

f &lt;-<span class="st"> </span>function (x, h){
  <span class="kw">sapply</span>(x, function(x) {
    x &lt;-<span class="st"> </span><span class="kw">pmax</span>(<span class="dv">0</span>, x -<span class="st"> </span>h)
    x *<span class="st"> </span><span class="kw">exp</span>(p[<span class="dv">1</span>] *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>x/p[<span class="dv">2</span>]) *<span class="st"> </span>(x -<span class="st"> </span>p[<span class="dv">3</span>])/p[<span class="dv">2</span>])
  })
}

pdfn &lt;-<span class="st"> </span>function(x, mu, <span class="dt">sigma =</span> sigma_g){
  <span class="kw">dlnorm</span>(x, <span class="kw">log</span>(mu), <span class="dt">sdlog =</span> sigma)
}

<span class="co"># Utility function</span>
discount =<span class="st"> </span><span class="fl">0.95</span>
get_utility &lt;-<span class="st"> </span>function(x,h) {
    <span class="kw">pmin</span>(x,h)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">R &lt;-<span class="st"> </span><span class="kw">outer</span>(states, actions, get_utility)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">transition_matrix &lt;-<span class="st"> </span>function(states, actions, f, pdfn){
  <span class="co"># Initialize</span>
  transition &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(states), <span class="kw">length</span>(actions)))
  
  K &lt;-<span class="st"> </span><span class="kw">length</span>(states)
  
  for (k in <span class="dv">1</span>:<span class="kw">length</span>(states)) {
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(actions)) {
  
  <span class="co"># Calculate the transition state at the next step, given the </span>
  <span class="co"># current state k and action i (harvest H[i])</span>
        nextpop &lt;-<span class="st"> </span><span class="kw">f</span>(states[k], actions[i])
        
        ## Population always extinct if this is negative. since multiplicitive shock z_t * f(n) &lt; 0 for all f(n) &lt; 0
        if(nextpop &lt;=<span class="st"> </span><span class="dv">0</span>)
          transition[k, , i] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">length</span>(states) -<span class="st"> </span><span class="dv">1</span>))
    <span class="co"># Implement demographic stochasticity </span>
        else {
  
        <span class="co"># Cts distributions need long-tailed denominator as normalizing factor:</span>
          fine_states &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(states), <span class="dv">10</span> *<span class="st"> </span><span class="kw">max</span>(states), <span class="dt">by =</span> states[<span class="dv">2</span>] -<span class="st"> </span>states[<span class="dv">1</span>])
        N &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">pdfn</span>(fine_states, nextpop))  
          transition[k, , i] &lt;-<span class="kw">pdfn</span>(states, nextpop) /<span class="st"> </span>N
          
            <span class="co"># We need to correct this density for the final capping state (&quot;Pile on boundary&quot;) (discrete or cts case)</span>
          <span class="co"># this can be a tiny but negative value due to floating-point errors. so we take max(v,0) to avoid</span>
        transition[k, K, i] &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="dv">1</span> -<span class="st"> </span><span class="kw">sum</span>(transition[k, -K, i]), <span class="dv">0</span>)
        }
    } 
  }
  transition
}

P &lt;-<span class="st"> </span><span class="kw">transition_matrix</span>(states, actions, f, pdfn)</code></pre>
<h2 id="using-toolbox">Using toolbox</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mdp_check</span>(<span class="dt">P =</span> P, <span class="dt">R =</span> R)</code></pre>
<pre><code>[1] &quot;&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">mdp &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(P, R, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> <span class="kw">numeric</span>(<span class="kw">length</span>(states)))</code></pre>
<pre><code>[1] &quot;MDP Toolbox: iterations stopped, epsilon-optimal policy found&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>actions[mdp$policy],  <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-29-mdptoolbox-allen-model/unnamed-chunk-6-1.png" />
</figure>
<h2 id="compare-to-reed">Compare to Reed</h2>
<p>From Reed (1979) we know that the optimal solution is a constant-escapement rule when the growth function in convex. Note that this condition is violated by the growth function with alternative stable states (Allen/Ricker-Allee model), resulting in a very different optimal policy:</p>
<p><span class="math">\[f&#39;(s^*) = 1/\alpha\]</span></p>
<p>For growth-rate function <span class="math">\(f\)</span>, where <span class="math">\(\alpha\)</span> is the discount factor and <span class="math">\(s^*\)</span> the stock size for the constant escapement. Analytic solutions are clearly possible for certain growth functions, but here I’ve just implemented a generic numerical solution.</p>
<pre class="sourceCode r"><code class="sourceCode r">fun &lt;-<span class="st"> </span>function(x) -<span class="st"> </span><span class="kw">f</span>(x,<span class="dv">0</span>) +<span class="st"> </span>x /<span class="st"> </span>discount
out &lt;-<span class="st"> </span><span class="kw">optimize</span>(<span class="dt">f =</span> fun, <span class="dt">interval =</span> <span class="kw">c</span>(<span class="dv">0</span>,K))
S_star &lt;-<span class="st"> </span>out$minimum

exact_policy &lt;-<span class="st"> </span><span class="kw">sapply</span>(states, 
                       function(x) 
                        if(x &lt;<span class="st"> </span>S_star) <span class="dv">0</span>
                        else x -<span class="st"> </span>S_star)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>actions[mdp$policy],  <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)

<span class="co"># The difference between Bellman and the analytical solution is small:</span>
<span class="kw">lines</span>(states, states -<span class="st"> </span>exact_policy)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-29-mdptoolbox-allen-model/unnamed-chunk-8-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/07/29/mdptoolbox-allen-model.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/07/29/fastgp-explore.html">Fastgp Explore</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 29 Jul 2015</p>

<article>
<div class="excerpt">
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(FastGP)
<span class="kw">library</span>(mvtnorm)
<span class="kw">library</span>(MASS)
<span class="kw">library</span>(rbenchmark)</code></pre>
<h2 id="demo-of-elliptical-slice-sampling">Demo of elliptical slice sampling</h2>
<p>Relevant Parameters:</p>
<pre class="sourceCode r"><code class="sourceCode r">A &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co">#amplitude of the sin function used for our signal</span>
T &lt;-<span class="st"> </span><span class="dv">5</span> <span class="co">#period of the sin function used as our signal</span>
sigma &lt;-<span class="st"> </span><span class="dv">10</span> <span class="co">#variance parameter in the covariance function</span>
phi &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co">#decay parameter for the exponential kernel</span>
N &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co">#number of time points </span></code></pre>
<p>A function that creates a signal, which can be toggled for multiple shapes. In the present iteration we use a sin function with variable period.</p>
<pre class="sourceCode r"><code class="sourceCode r">signal &lt;-<span class="st"> </span>function(t) {
  <span class="kw">return</span>(A*<span class="kw">sin</span>(t/T))
}</code></pre>
<p>Define our covariance matrix using the exponential kernel</p>
<pre class="sourceCode r"><code class="sourceCode r">S &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(sigma*<span class="kw">exp</span>(-<span class="kw">as.matrix</span>(<span class="kw">dist</span>(<span class="kw">seq</span>(<span class="dv">1</span>,N)))^<span class="dv">2</span>/phi))</code></pre>
<p>Generate a copy of the signal on the time scale of 1…N</p>
<pre class="sourceCode r"><code class="sourceCode r">t &lt;-<span class="st"> </span><span class="kw">mvrnorm</span>(<span class="dt">n =</span> <span class="dv">1</span>, <span class="dt">mu =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">100</span>), <span class="dt">Sigma =</span> S , <span class="dt">tol =</span> <span class="fl">1e-6</span>)
s &lt;-<span class="st"> </span><span class="kw">signal</span>(<span class="kw">seq</span>(<span class="dv">1</span>,N)+t)+<span class="kw">rnorm</span>(N,<span class="dt">sd=</span><span class="kw">sqrt</span>(.<span class="dv">001</span>))</code></pre>
<p>log-lik functions</p>
<pre class="sourceCode r"><code class="sourceCode r">log_lik &lt;-<span class="st"> </span>function(w,s){
  <span class="kw">return</span> (<span class="kw">dmvnorm</span>(s, <span class="dt">mean =</span> <span class="kw">signal</span>(<span class="kw">seq</span>(<span class="dv">1</span>:N)+w),<span class="dt">sigma=</span>.<span class="dv">001</span>*<span class="kw">diag</span>(<span class="dv">1</span>,N),<span class="dt">log=</span>T))
}

<span class="co">#rcpp based log-lik function</span>
log_lik_rcpp &lt;-<span class="st"> </span>function(w,s){
  <span class="kw">return</span> (<span class="kw">rcpp_log_dmvnorm</span>(<span class="dt">S =</span> .<span class="dv">001</span>*<span class="kw">diag</span>(<span class="dv">1</span>,N),<span class="dt">mu=</span><span class="kw">signal</span>(<span class="kw">seq</span>(<span class="dv">1</span>:N)+w),s,<span class="dt">istoep=</span><span class="ot">TRUE</span>))
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">X &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">seq</span>(<span class="dv">1</span>,N),<span class="dt">nrow=</span>N)
Sig &lt;-<span class="st"> </span>sigma*<span class="kw">exp</span>(-<span class="kw">rcpp_distance</span>(X,<span class="kw">dim</span>(X)[<span class="dv">1</span>],<span class="kw">dim</span>(X)[<span class="dv">2</span>])^<span class="dv">2</span>/phi)</code></pre>
<p>and here we go:</p>
<pre class="sourceCode r"><code class="sourceCode r">mcmc_samples &lt;-<span class="st"> </span><span class="kw">ess</span>(log_lik_rcpp,s,Sig,<span class="dv">1000</span>,<span class="dv">250</span>,<span class="dv">100</span>,<span class="ot">TRUE</span>)</code></pre>
<pre><code>[1] &quot;Running elliptical slice sampling...&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))
<span class="kw">plot</span>(<span class="kw">colMeans</span>(mcmc_samples), <span class="dt">type=</span><span class="st">&quot;l&quot;</span>)
<span class="kw">points</span>(t, <span class="dt">type=</span><span class="st">&quot;l&quot;</span>, <span class="dt">lwd=</span><span class="dv">3</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)
<span class="kw">points</span>(<span class="kw">colMeans</span>(mcmc_samples) +<span class="st"> </span><span class="dv">2</span>*<span class="st"> </span><span class="kw">apply</span>(mcmc_samples, <span class="dv">2</span>, sd), <span class="dt">type=</span><span class="st">&quot;l&quot;</span>, <span class="dt">lty=</span><span class="st">&quot;dashed&quot;</span>)
<span class="kw">points</span>(<span class="kw">colMeans</span>(mcmc_samples) -<span class="st"> </span><span class="dv">2</span>*<span class="st"> </span><span class="kw">apply</span>(mcmc_samples, <span class="dv">2</span>, sd), <span class="dt">type=</span><span class="st">&quot;l&quot;</span>, <span class="dt">lty=</span><span class="st">&quot;dashed&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-29-fastgp-explore/unnamed-chunk-9-1.png" />
</figure>
<p>test <code>ess</code> with rcpp likelihood versus non rcpp likelihood</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">benchmark</span>(<span class="kw">ess</span>(log_lik_rcpp,s,Sig,<span class="dv">1000</span>,<span class="dv">250</span>,<span class="dv">100</span>,<span class="ot">FALSE</span>), <span class="kw">ess</span>(log_lik,s,Sig,<span class="dv">1000</span>,<span class="dv">250</span>,<span class="dv">100</span>,<span class="ot">TRUE</span>),<span class="dt">replications=</span><span class="dv">2</span>)</code></pre>
<pre><code>[1] &quot;Running elliptical slice sampling...&quot;
[1] &quot;Running elliptical slice sampling...&quot;
[1] &quot;Running elliptical slice sampling...&quot;
[1] &quot;Running elliptical slice sampling...&quot;
[1] &quot;Running elliptical slice sampling...&quot;
[1] &quot;Running elliptical slice sampling...&quot;</code></pre>
<pre><code>                                              test replications
1 ess(log_lik_rcpp, s, Sig, 1000, 250, 100, FALSE)            2
2       ess(log_lik, s, Sig, 1000, 250, 100, TRUE)            2
  elapsed relative user.self sys.self user.child sys.child
1  19.480    1.000    19.592    0.636          0         0
2  33.818    1.736    46.504   87.208          0         0</code></pre>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/07/29/fastgp-explore.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
        <div class="col-md-3">
          <header><h4><a href="/2015/07/14/mdptoolbox-ex-2.html">Mdptoolbox Ex 2</a></h4></header>
<p><span></span></p>
<p style="font-style:italic"> 14 Jul 2015</p>

<article>
<div class="excerpt">
<p>Adapted from Marescot et al. appendix 5, to Reed optimal control problem, including direct comparison against (semi) analytic optimum.</p>
<h2 id="step-1-define-objectives">step 1: define objectives</h2>
<p>This is a conceptual step which does not require coding</p>
<h2 id="step-2-define-states">step 2: define states</h2>
<pre class="sourceCode r"><code class="sourceCode r">K &lt;-<span class="st"> </span><span class="dv">150</span> <span class="co"># state space limit</span>
states &lt;-<span class="st"> </span><span class="dv">0</span>:K <span class="co"># Vector of all possible states</span></code></pre>
<h2 id="step-3-define-control-actions">step 3: define control actions</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Vector of actions: harvest</span>
H &lt;-<span class="st"> </span>states</code></pre>
<h2 id="step-4-define-dynamic-model-with-demographic-parameters">step 4: define dynamic model (with demographic parameters)</h2>
<pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">6</span>,<span class="fl">0.05</span>)
f &lt;-<span class="st"> </span>function(x, h){
  A &lt;-<span class="st"> </span>p[<span class="dv">1</span>] 
  B &lt;-<span class="st"> </span>p[<span class="dv">2</span>] 
  s &lt;-<span class="st"> </span><span class="kw">pmax</span>(x-h, <span class="dv">0</span>)
  A *<span class="st"> </span>s/(<span class="dv">1</span> +<span class="st"> </span>B *<span class="st"> </span>s)
}

sigma_g =<span class="st"> </span><span class="fl">0.1</span></code></pre>
<h2 id="step-5-define-utility">step 5: define utility</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Utility function</span>
get_utility &lt;-<span class="st"> </span>function(x,h) {
    <span class="kw">pmin</span>(x,h)
}</code></pre>
<h2 id="step-6-solve-bellman-equation-with-value-iteration">step 6: solve bellman equation with value iteration</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Initialize transition matrix</span>
transition &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(states), <span class="kw">length</span>(H)))

<span class="co"># Initialize utility matrix</span>
utility &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(H)))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fill in the transition and utility matrix</span>
<span class="co"># Loop on all states</span>
for (k in <span class="dv">0</span>:K) {

    <span class="co"># Loop on all actions</span>
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(H)) {

<span class="co"># Calculate the transition state at the next step, given the </span>
<span class="co"># current state k and the harvest H[i]</span>
        nextpop &lt;-<span class="st"> </span><span class="kw">f</span>(k, H[i])
        if(nextpop &lt;=<span class="st"> </span><span class="dv">0</span>)
          transition[k<span class="dv">+1</span>, , i] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">length</span>(states) -<span class="st"> </span><span class="dv">1</span>))
    <span class="co"># Implement demographic stochasticity by drawing </span>
  <span class="co"># probability from a density function</span>
        else {

<span class="co"># We need to correct this density for the final capping state (&quot;Pile on boundary&quot;)</span>
<span class="co"># For discrete probability distribution, this is easy if `states` includes all possible</span>
<span class="co"># discrete states below the capping state (e.g. all non-negative integers less than K).  </span>
<span class="co"># For a continuous distribution, this is more problematic as we have to first normalize the densities.</span>
<span class="co"># EDIT: this can be negative, due to floating-point errors. so we take max(v,0) to avoid</span>

<span class="co"># Get long-tailed denominator as normalizing factor (continuous distributions only):</span>
          fine_states &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(states), <span class="dv">10</span> *<span class="st"> </span><span class="kw">max</span>(states), <span class="dt">by =</span> states[<span class="dv">2</span>]-states[<span class="dv">1</span>])
        N &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">dlnorm</span>(fine_states, <span class="kw">log</span>(nextpop), <span class="dt">sdlog =</span> sigma_g))

      transition[k<span class="dv">+1</span>, , i] &lt;-<span class="st"> </span><span class="kw">dlnorm</span>(states, <span class="kw">log</span>(nextpop), <span class="dt">sdlog =</span> sigma_g) /<span class="st"> </span>N
      
        <span class="co"># We need to correct this density for the final capping state (&quot;Pile on boundary&quot;)</span>
        transition[k<span class="dv">+1</span>, K<span class="dv">+1</span>, i] &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="dv">1</span> -<span class="st"> </span><span class="kw">sum</span>(transition[k<span class="dv">+1</span>, -(K<span class="dv">+1</span>), i]), <span class="dv">0</span>)

        }
        
        <span class="co"># Compute utility</span>
        utility[k<span class="dv">+1</span>, i] &lt;-<span class="st"> </span><span class="kw">get_utility</span>(k, H[i])

    } <span class="co"># end of action loop</span>
} <span class="co"># end of state loop</span></code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Discount factor</span>
discount &lt;-<span class="st"> </span><span class="fl">0.95</span>

<span class="co"># Action value vector at tmax</span>
Vtmax &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))

<span class="co"># Action value vector at t and t+1</span>
Vt &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))
Vtplus &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))

<span class="co"># Optimal policy vector</span>
D &lt;-<span class="st"> </span><span class="kw">numeric</span>(<span class="kw">length</span>(states))

<span class="co"># Time horizon</span>
Tmax &lt;-<span class="st"> </span><span class="dv">150</span></code></pre>
<h2 id="solution-calculated-explicitly">Solution calculated explicitly:</h2>
<p>The backward iteration consists in storing action values in the vector <code>Vt</code> which is the maximum of utility plus the future action values for all possible next states. Knowing the final action values, we can then backwardly reset the next action value <code>Vtplus</code> to the new value <code>Vt</code>. We start The backward iteration at time <code>T-1</code> since we already defined the action value at <code>Tmax</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">for (t in (Tmax -<span class="st"> </span><span class="dv">1</span>):<span class="dv">1</span>) {

<span class="co"># We define a matrix Q that stores the updated action values for </span>
<span class="co"># all states (rows)</span>
<span class="co"># actions (columns)</span>
    Q &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">length</span>(states), <span class="kw">length</span>(H)))
    
    for (i in <span class="dv">1</span>:<span class="kw">length</span>(H)) {
    
<span class="co"># For each harvest rate we fill for all states values (row) </span>
<span class="co"># the ith column (Action) of matrix Q</span>
<span class="co"># The utility of the ith action recorded for all states is </span>
<span class="co"># added to the product of the transition matrix of the ith </span>
<span class="co"># action by the action value of all states </span>
        Q[,i] &lt;-<span class="st"> </span>utility[, i] +<span class="st"> </span>discount *<span class="st"> </span>(transition[,,i] %*%<span class="st"> </span>Vtplus)
    
    } <span class="co"># end of the harvest loop</span>

    <span class="co"># Find the optimal action value at time t is the maximum of Q</span>
    Vt &lt;-<span class="st"> </span><span class="kw">apply</span>(Q, <span class="dv">1</span>, max)

<span class="co"># After filling vector Vt of the action values at all states, we </span>
<span class="co"># update the vector Vt+1 to Vt and we go to the next step standing </span>
<span class="co"># for previous time t-1, since we iterate backward</span>
    Vtplus &lt;-<span class="st"> </span>Vt

} <span class="co"># end of the time loop</span>

<span class="co"># Find optimal action for each state</span>
for (k in <span class="dv">0</span>:K) {
<span class="co"># We look for each state which column of Q corresponds to the </span>
<span class="co"># maximum of the last updated value </span>
<span class="co"># of Vt (the one at time t + 1). If the index vector is longer than 1 </span>
<span class="co"># (if there is more than one optimal value we chose the minimum </span>
<span class="co"># harvest rate)</span>
    D[k +<span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span>H[(<span class="kw">min</span>(<span class="kw">which</span>(Q[k +<span class="st"> </span><span class="dv">1</span>, ] ==<span class="st"> </span>Vt[k +<span class="st"> </span><span class="dv">1</span>])))]
}</code></pre>
<h2 id="plot-solution">plot solution</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>D, <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-14-mdptoolbox-ex-2/unnamed-chunk-9-1.png" />
</figure>
<h2 id="proof-of-optimality-compare-with-analytical-solution">proof of optimality: compare with analytical solution</h2>
<p>From Reed (1979) we know that the optimal solution is a constant-escapement rule:</p>
<p><span class="math">\[f&#39;(s^*) = 1/\alpha\]</span></p>
<p>For growth-rate function <span class="math">\(f\)</span>, where <span class="math">\(\alpha\)</span> is the discount factor and <span class="math">\(s^*\)</span> the stock size for the constant escapement. Analytic solutions are clearly possible for certain growth functions, but here I’ve just implemented a generic numerical solution.</p>
<pre class="sourceCode r"><code class="sourceCode r">fun &lt;-<span class="st"> </span>function(x) -<span class="st"> </span><span class="kw">f</span>(x,<span class="dv">0</span>) +<span class="st"> </span>x /<span class="st"> </span>discount
out &lt;-<span class="st"> </span><span class="kw">optimize</span>(<span class="dt">f =</span> fun, <span class="dt">interval =</span> <span class="kw">c</span>(<span class="dv">0</span>,K))
S_star &lt;-<span class="st"> </span>out$minimum

exact_policy &lt;-<span class="st"> </span><span class="kw">sapply</span>(states, 
                       function(x) 
                        if(x &lt;<span class="st"> </span>S_star) <span class="dv">0</span>
                        else x -<span class="st"> </span>S_star)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>D, <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)

<span class="co"># The difference between Bellman equation solution and the analytical </span>
<span class="co"># solution is small:</span>
<span class="kw">lines</span>(states, states -<span class="st"> </span>exact_policy)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-14-mdptoolbox-ex-2/unnamed-chunk-11-1.png" />
</figure>
<h2 id="using-toolbox">Using toolbox</h2>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;MDPtoolbox&quot;</span>)
<span class="kw">mdp_check</span>(<span class="dt">P =</span> transition, <span class="dt">R =</span> utility)</code></pre>
<pre><code>[1] &quot;&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">out &lt;-<span class="st"> </span><span class="kw">mdp_value_iteration</span>(transition, utility, <span class="dt">discount =</span> discount, <span class="dt">epsilon =</span> <span class="fl">0.001</span>, <span class="dt">max_iter =</span> <span class="fl">5e3</span>, <span class="dt">V0 =</span> Vtmax)</code></pre>
<pre><code>[1] &quot;MDP Toolbox: iterations stopped, epsilon-optimal policy found&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(states, states -<span class="st"> </span>D, <span class="dt">xlab=</span><span class="st">&quot;Population size&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Escapement&quot;</span>)
<span class="kw">lines</span>(states, states -<span class="st"> </span>H[out$policy], <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</code></pre>
<figure>
<img src="/2015/assets/figures/posts/2015-07-14-mdptoolbox-ex-2/unnamed-chunk-13-1.png" />
</figure>
 
<!-- not that raw_content depends on custom generator, 
     see _plugins/jekyll-labnotebook-plugins/raw_content --> 
</article> 
<p> <a href="/2015/07/14/mdptoolbox-ex-2.html"> <em>Read more</em></a> </p>
<br />
<br />


        </div>
      
    </div>

  </div>
</div> <!--end row -->

<div class="row socialicons">
  <div class="col-md-11 col-md-offset-1">
		<p> <a href="/2015/index.html"><i class="icon-calendar"></i> All entries by date</a></p> 
      <p> <a href="/2015/categories.html"><i class="icon-list"></i> All entries by category</a> </p>
      <p> <a href="/2015/tags.html"><i class="icon-tags"></i> All entries by tag</a> </p>
  </div> <!--end col-md-9 -->
</div> <!--end row -->




      <footer class="footer">

<!--************** FOAF information to social networks ***************************** -->
  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="https://www.carlboettiger.info#me">
      <p>
          <script type="text/javascript" src="/assets/js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
      <!--
          <a rel="foaf:account" href="https://plus.google.com/" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'GPlus'); 
             return false;"><i class="fa fa-google-plus"></i></a>

          <a rel="foaf:account" href="https://www.mendeley.com/profiles/carl-boettiger" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Mendeley'); 
             return false;"><img src="/assets/img/icon-mendeley.png" /></a> 

           citations on google-scholar

           stackoverflow
      -->
      <a rel="foaf:weblog" type="application/atom+xml" href="/blog.xml"  
         class="showtooltip" title="RSS feeds for my blog-style entries. See the feed on my lab notebook (/atom.xml) to follow all entries instead." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    <!--**************** End social links **************************** -->


    <div class="col-md-4 col-md-offset-1 col-xs-4">
      <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="https://onsclaims.wikispaces.com/"><img src="/assets/img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="https://creativecommons.org/ns#license" href="https://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="/assets/img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>


  
<!-- COinS metadata (for citation managers like Zotero etc), goes in body text -->
  <span
      class="Z3988" 
      title="ctx_ver=Z39.88-2004
      &amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Adc
      &amp;rfr_id=info%3Asid%2Focoins.info%3Agenerator
      &amp;rft.title=Lab Notebook
      &amp;rft.creator=Carl Boettiger
      &amp;rft.date=
      &amp;rft.language=EN
      &amp;rft.rights=CC0
      &amp;rft_id=https://www.carlboettiger.info/lab-notebook">
  </span>


</footer>




          <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <!-- JQuery, used on a few pages (still?) -->
    <!-- <script type="text/javascript" src="/assets/js/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Equations using MathJax -->
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });       </script>
    <!-- Twitter Bootstrap Javascript -->
    <!--  <script src="/assets/js/bootstrap.min.js"></script> -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>


    

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-18401403-1']);
          _gaq.push(['_trackPageview']);
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
  </script>



<script type="text/javascript">
function recordOutboundLink(link, category, action) {
  try {
    var pageTracker=_gat._getTracker("UA-18401403-1");
    pageTracker._trackEvent(category, action);
    setTimeout('document.location = "' + link.href + '"', 100)
  }catch(err){}
}
</script>




    </div>
  </body>
</html>
   
