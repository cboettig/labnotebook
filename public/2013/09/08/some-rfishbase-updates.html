<!DOCTYPE html>
<html lang="en" xmlns="https://www.w3.org/1999/xhtml" xml:lang="en">
  <head prefix="dc: https://purl.org/dc/terms/ og: https://ogp.me/ns#"> <!-- namespaces used in metadata.html -->
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
  <title>Some Rfishbase Updates</title>
  <meta name="author" content="Carl Boettiger" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- HTML5 metadata -->
<meta name="keywords" content="ropensci" />
<meta name="description" content="" />
<!-- RDFa Metadata (in DublinCore) -->
<meta property="dc:title" content="Some Rfishbase Updates" />
<meta property="dc:creator" content="Carl Boettiger" />
<meta property="dc:date" content="2013-09-08 00:00:00 +0000" />
<meta property="dc:format" content="text/html" />
<meta property="dc:language" content="en" />
<meta property="dc:identifier" content="/09/08/some-rfishbase-updates.html" />
<meta property="dc:rights" content="CC0" />
<meta property="dc:source" content="Lab Notebook" />
<meta property="dc:subject" content="Ecology" /> 
<meta property="dc:type" content="website" /> 
<!-- RDFa Metadata (in OpenGraph) -->
<meta property="og:title" content="Some Rfishbase Updates" />
<meta property="og:author" content="https://www.carlboettiger.info/index.html#me" />  <!-- Should be Liquid? URI? -->
<meta property="https://ogp.me/ns/profile#first_name" content="Carl"/>
<meta property="https://ogp.me/ns/profile#last_name" content="Boettiger"/>
<meta property="https://ogp.me/ns/article#published_time" content="2013-09-08 00:00:00 +0000" />
<meta property="og:site_name" content="Lab Notebook" /> <!-- Same as dc:source? -->
<meta property="og:url" content="https://www.carlboettiger.info/09/08/some-rfishbase-updates.html" />
<meta property="og:type" content="website" /> 
<!-- Google Scholar Metadata -->
<!--
<meta name="citation_author" content="Carl Boettiger"/>
<meta name="citation_date" content="2013-09-08 00:00:00 +0000"/>
<meta name="citation_title" content="Some Rfishbase Updates"/>
<meta name="citation_journal_title" content="Lab Notebook"/>
-->
<!--NOTE: see also the COinS Metadata in span element in footer -->




	<link href="https://www.carlboettiger.info/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <!-- Help the browser identify the RSS feed automatically -->
  <link rel="alternate" type="application/rss+xml" title="Carl Boettiger's Lab Notebook" href="/blog.xml" />
</head>


  <body prefix="dc: https://purl.org/dc/terms/ foaf: https://xmlns.com/foaf/0.1/"> 
    <!-- Navbar  ================================================== -->

<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/README.html"><i class="icon-info-sign"></i></a>
    </div>

 <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

          <li  >
          <a href="/index.html">Home</a></li>
          <li  >
          <a href="/vita.html">Vita</a></li>
          <li  >
          <a href="/research.html">Research</a></li>
          <li  >
          <a href="/teaching.html">Teaching</a></li>
          <li  >
          <a href="/community.html">Community</a></li>
          <li  >
          <a href="/lab-notebook.html">Lab Notebook</a></li>

        </ul>

      <!-- Search site using Google's index -->
        <form class="navbar-form navbar-right" role="search" method="get" action="https://google.com/search">
          <div class="form-group">
            <input type="hidden" name="q" value="site:carlboettiger.info" />
            <input type="text" class="form-control search-query" name="q" placeholder="Search"/>
          </div>
          <button class="btn btn-mini" type="submit"><i class="icon-search"></i></button> 
       </form>

    </div><!--/.nav-collapse -->
  </div> <!-- /container -->
</nav>



    <div class="container"> <!-- Responsive grid layout, doesn't jump to full-width --> 
      <header>
        <h1 class="entry-title">Some Rfishbase Updates</h1>
        <h2></h2>
      </header>

      <div class="row">
  <div class="col-md-7 col-md-offset-1">
    <article>
    <p>Ever since writing the <code>rfishbase</code> package I’ve been frustrated by the lack of a proper API from Fishbase.org that would allow access to that wealth of information that is not exposed in the “Summary XML” files from which <code>rfishbase</code> extracts its content. Since writing the paper in Journal of Fish Biology, I continue to receive user requests asking if or how such-and-such a data element might be extracted. Usually this involves a disappointing boiler-plate reply about how the package is limited to the “Summary XML” data and that improved query potential must wait for a proper API from Fishbase.org at some unspecified time.</p>
<p>I have been in touch with many of the folks at Fishbase.org at various times looking for ways to address these issues. They have been in general keenly supportive of the idea, but I gather that they are largely overworked and under-resourced and as such, implementation of any of these steps has been very slow. Last October another rfishbase user contacted me, who works full time as a software developer. I put him in touch with the UBC team, and he is willing to volunteer the hours and expertise the FishBase development team lacks to help transform the database into a full API. I think this is a very promising development and a nice example of a community effort, but still faces the same fundamental challenges in getting things rolling. So, so far, no <code>rfishbase</code> version 2. (Actually in our semantic versioning it would be the less romantic version 0.3 or 0.4 or so, depending on how many CRAN submits we do before then and provided we don’t break any backwards compatibility)…</p>
<p>One of the more frequent requests involves accessing quantitative trophic level estimates provided for many species on the “Ecology” page, linked from the “Summary page”. The only way to access this data is by scraping the HTML.</p>
<p>Previously I’ve been reluctant to scrape the HTML directly for several reasons:</p>
<ul>
<li><p>It is generally unrealiable/unverifiable. Without any metadata (rdfa or microdata/microformats could have helped…) in the HTML to signpost that we have the correct value, we are generally counting arbitrary header, div and span elements, followed by some Regular Expression matching, to find the element we want.<br />This is error-prone and easily broken by any changes in the html pages either over time or between pages for different species.</p></li>
<li><p>Second, it puts a much greater load on the fishbase servers. Often we cannot even start by querying the page we want, (e.g. since URLs involve things like stock-ids that the end user will not know and I haven’t located a look-up table), so a single call may follow links through several pages before parsing the data it needs. Repeating such queries over many fish programmatically can create a rather substantial burst of traffic that could slow or crash the servers.</p></li>
<li><p>It’s slow. Making all the queries takes time, even for a computer. (Though caching, as we already do in rfishbase, could take care of much this).</p></li>
<li><p>It is potentially time consuming and annoying to code the scaping.</p></li>
</ul>
<p>Okay, the last is just me being lazy. Since this particular query about trophic level was a common email request, and as the data was available from the “Ecology” page of a species in the form of an HTML Table, (and hence somewhat less fragile to robustly identify…), I thought I’d give it a try.</p>
<p>Here’s my approach (or see <a href="">source code</a>). We would follow the same query structure as <code>getSize</code> did <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>, and execute several steps:</p>
<ol type="1">
<li>Visit the Summary page of the requested fish</li>
<li>Find it’s Ecology page</li>
<li>Find the Trophic level table</li>
<li>parse the table.</li>
</ol>
<p>In code, that looks like this:</p>
<pre class="sourceCode r"><code class="sourceCode r">getTrophicLevel &lt;-<span class="st"> </span>function(<span class="dt">fish.data =</span> <span class="ot">NULL</span>,
                            <span class="dt">path =</span> <span class="ot">NULL</span>,
                            <span class="dt">as_table=</span><span class="ot">FALSE</span>, 
                            <span class="dt">from =</span> <span class="kw">c</span>(<span class="st">&quot;diet composition&quot;</span>, <span class="st">&quot;individual food items&quot;</span>), 
                            <span class="dt">unfished =</span> <span class="ot">FALSE</span>,
                            <span class="dt">justSE =</span> <span class="ot">FALSE</span>,
                            <span class="dt">justReference =</span> <span class="ot">FALSE</span>){

  ids &lt;-<span class="st"> </span><span class="kw">getIds</span>(<span class="dt">fish.data =</span> fish.data, <span class="dt">path=</span>path)
  out &lt;-<span class="st"> </span><span class="kw">sapply</span>(ids, function(id){
    summaryPage &lt;-<span class="st"> </span><span class="kw">getSummary</span>(id)
    ecologyPage &lt;-<span class="st"> </span><span class="kw">getEcology</span>(summaryPage)
    tab &lt;-<span class="st"> </span><span class="kw">readTrophicLevel</span>(ecologyPage)
    if(as_table)
      tab
    else
      <span class="kw">parseTrophicLevel</span>(tab, <span class="dt">from=</span>from, <span class="dt">unfished=</span>unfished,<span class="dt">justSE=</span>justSE, <span class="dt">justReference=</span>justReference)
    })
  out
}</code></pre>
<p>Which has a whole bunch of options just to let the user control the format of the output / target value, since there are different numbers.</p>
<p>Each of the steps corresponds to it’s own function:</p>
<pre class="sourceCode r"><code class="sourceCode r">getIds &lt;-<span class="st"> </span>function(<span class="dt">fish.data=</span><span class="ot">NULL</span>, <span class="dt">path=</span><span class="ot">NULL</span>){
  if(<span class="kw">is.null</span>(fish.data))
    fish.data &lt;-<span class="st"> </span><span class="kw">loadCache</span>(<span class="dt">path=</span>path)
  ids &lt;-<span class="st"> </span><span class="kw">sapply</span>(fish.data, <span class="st">`</span><span class="dt">[[</span><span class="st">`</span>, <span class="st">&#39;id&#39;</span>)
  species.names &lt;-<span class="st"> </span><span class="kw">sapply</span>(fish.data, <span class="st">`</span><span class="dt">[[</span><span class="st">`</span>, <span class="st">&#39;ScientificName&#39;</span>)
  <span class="kw">names</span>(ids) &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, species.names) <span class="co"># use underscores instead of spaces</span>
  ids
}


getSummary &lt;-<span class="st"> </span>function(id){ 
  <span class="co"># Grab and parse page matching id</span>
  url &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;https://www.fishbase.org/summary/speciessummary.php?id=&quot;</span>, id)
  summaryPage &lt;-<span class="st"> </span><span class="kw">htmlParse</span>(url) 
}

getEcology &lt;-<span class="st"> </span>function(summaryPage){
  link &lt;-<span class="st"> </span><span class="kw">xpathApply</span>(summaryPage, <span class="st">&quot;//*[contains(@href, &#39;/Ecology/FishEcologySummary.php&#39;)][1]&quot;</span>, xmlAttrs)[[<span class="dv">1</span>]][[<span class="st">&quot;href&quot;</span>]]
  ecologyPage &lt;-<span class="st"> </span><span class="kw">htmlParse</span>(<span class="kw">paste0</span>(<span class="st">&quot;https://www.fishbase.org/&quot;</span>, <span class="kw">gsub</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">.</span><span class="ch">\\</span><span class="st">./&quot;</span>, <span class="st">&quot;&quot;</span>, link)))
}


readTrophicLevel &lt;-<span class="st"> </span>function(ecologyPage){ 
  tab &lt;-<span class="st"> </span><span class="kw">readHTMLTable</span>(ecologyPage)[[<span class="dv">6</span>]]
}</code></pre>
<p>which are all nice and short and potentially self-explanatory. Extracting values from the table we isolate is done rather crudely at the moment and could no doubt be improved, but this is what I came up with:</p>
<pre class="sourceCode r"><code class="sourceCode r">parseTrophicLevel &lt;-<span class="st"> </span>function(tab, 
                              <span class="dt">from =</span> <span class="kw">c</span>(<span class="st">&quot;diet composition&quot;</span>, <span class="st">&quot;individual food items&quot;</span>), 
                              <span class="dt">unfished =</span> <span class="ot">FALSE</span>,
                              <span class="dt">justSE =</span> <span class="ot">FALSE</span>,
                              <span class="dt">justReference =</span> <span class="ot">FALSE</span>){
  from &lt;-<span class="st"> </span><span class="kw">match.arg</span>(from)
  if(justReference)
    out &lt;-<span class="st"> </span><span class="kw">as.character</span>(tab[<span class="dv">3</span>,<span class="dv">2</span>])
  else{
    col &lt;-<span class="st"> </span><span class="dv">2</span>
    adj &lt;-<span class="st"> </span><span class="dv">0</span>
    if(unfished)
      col &lt;-<span class="st"> </span><span class="dv">4</span>
    if(justSE)
      adj &lt;-<span class="st"> </span><span class="dv">1</span>
    if(from ==<span class="st"> &quot;diet composition&quot;</span>)
      out &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(tab[<span class="dv">2</span>,col+adj]))
    else if(from ==<span class="st"> &quot;individual food items&quot;</span>)
      out &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(tab[<span class="dv">4</span>,col+adj]))
  }
  out 
}</code></pre>
<p>Most of these are internal functions of course, only the top <code>getTrophicLevel</code> is user-facing.<br />The use is straight forward:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(rfishbase)
<span class="kw">data</span>(fishbase)

<span class="kw">getTrophicLevel</span>(fish.data[<span class="dv">1</span>:<span class="dv">10</span>])</code></pre>
<p>or any of the various optional configurations, e.g.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">getTrophicLevel</span>(fish.data[<span class="dv">1</span>:<span class="dv">10</span>], <span class="dt">as_table=</span><span class="ot">TRUE</span>)</code></pre>
<p>(which gives a list of tables matching these fish).</p>
<p>The astute reader might notice that with <code>EcologyPage</code> etc we have access to a lot more (tabular) data in this approach, which could be extended beyond that page as well, following the same template shown here. Just a matter of time and the other limitations discussed above.</p>
<p>So anyway, if you need the getTrophicLevel, it’s available now on the <a href="https://github.com/ropensci/rfishbase/issues/12">Github version</a> and should be on CRAN in the near future. Meanwhile, I’d certainly welcome other requests (or better yet, forks and pull requests implementing additional data fields along these same lines).</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>taking the <code>fish.data</code> list as an argument – potentially a weird choice but oh well, that’s what I did when I first wrote the rfishbase API so may as well keep it. A more natural choice taking scientific names as arguments directly, instead of needing to start with a which_fish query, should be added one day to the entire package API.<a href="#fnref1">↩</a></p></li>
</ol>
</section>

    </article>
  </div>
  <div class="col-md-4">
    <div class="sidebar">
      <aside prefix="og:https://ogp.me/ns/article#">
  <p> <i class="icon-calendar"></i>
    <time datetime="2013-09-08 00:00:00 +0000" 
    property="dc:created">08 Sep 2013</time></p>
   

 <br />

  
	<p><a class="btn btn-default" rel="prev" href='/2013/09/07/RNeXML-milestone.html'><i class="icon-chevron-left"></i> prev</a>
  
  
  <a class="btn btn-default" rel="next" href='/2013/09/09/lost-branches.html'>next <i class="icon-chevron-right"></i></a></p>
  

  <br />

  <p> <a  onclick="recordOutboundLink(this, 'Outbound Links', 'history'); 
            return false;" 
          class="btn btn-default" 
          href="https://github.com/cboettig/2013/commits/master/_posts/2013-09-08-some-rfishbase-updates.md"><i class="icon-time"></i> history</a></p>

  <br />

  <p><i class="icon-list"></i> Posted in 
     
      <a rel="dc:subject" class="category" 
         href="/2013/categories.html#ecology">ecology</a>
    
    </p>

  <p> <i class="icon-tag"></i> tags: 
    
    <!-- https://schema.org/BlogPosting/keywords -->
    <a rel="og:tag" class="tag" 
			href="/2013/tags.html#ropensci">#ropensci</a>
    </p>

  <br/>

  

  <br/>
  <p><small> <i class="icon-barcode"></i> SHA Hash: <a href="https://github.com/cboettig/2013/commit/1a9f220e72e868aeb52ad4bdac743928a7282785/_posts/2013-09-08-some-rfishbase-updates.md"> 1a9f220e72e868aeb52ad4bdac743928a7282785</a></small></p>
    
  <br/>
  

</aside>

    </div>
  </div>
</div>

      <!-- Disqus Comments -->
      <div class="row disqus">
        <div class="col-md-8">          
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'cboettig'; // required: replace example with your forum shortname
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
      </div>






      <footer class="footer">

<!--************** FOAF information to social networks ***************************** -->
  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="https://www.carlboettiger.info#me">
      <p>
          <script type="text/javascript" src="/assets/js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
      <!--
          <a rel="foaf:account" href="https://plus.google.com/" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'GPlus'); 
             return false;"><i class="fa fa-google-plus"></i></a>

          <a rel="foaf:account" href="https://www.mendeley.com/profiles/carl-boettiger" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Mendeley'); 
             return false;"><img src="/assets/img/icon-mendeley.png" /></a> 

           citations on google-scholar

           stackoverflow
      -->
      <a rel="foaf:weblog" type="application/atom+xml" href="/blog.xml"  
         class="showtooltip" title="RSS feeds for my blog-style entries. See the feed on my lab notebook (/atom.xml) to follow all entries instead." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    <!--**************** End social links **************************** -->


    <div class="col-md-4 col-md-offset-1 col-xs-4">
      <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="https://onsclaims.wikispaces.com/"><img src="/assets/img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="https://creativecommons.org/ns#license" href="https://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="/assets/img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>


  
<!-- COinS metadata (for citation managers like Zotero etc), goes in body text -->
  <span
      class="Z3988" 
      title="ctx_ver=Z39.88-2004
      &amp;rft_val_fmt=info%3Aofi%2Ffmt%3Akev%3Amtx%3Adc
      &amp;rfr_id=info%3Asid%2Focoins.info%3Agenerator
      &amp;rft.title=Some Rfishbase Updates
      &amp;rft.creator=Carl Boettiger
      &amp;rft.date=2013-09-08
      &amp;rft.language=EN
      &amp;rft.rights=CC0
      &amp;rft_id=https://www.carlboettiger.info/09/08/some-rfishbase-updates.html">
  </span>


</footer>




          <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <!-- JQuery, used on a few pages (still?) -->
    <!-- <script type="text/javascript" src="/assets/js/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Equations using MathJax -->
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });       </script>
    <!-- Twitter Bootstrap Javascript -->
    <!--  <script src="/assets/js/bootstrap.min.js"></script> -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>


    

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-18401403-1']);
          _gaq.push(['_trackPageview']);
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
  </script>



<script type="text/javascript">
function recordOutboundLink(link, category, action) {
  try {
    var pageTracker=_gat._getTracker("UA-18401403-1");
    pageTracker._trackEvent(category, action);
    setTimeout('document.location = "' + link.href + '"', 100)
  }catch(err){}
}
</script>




    </div>
  </body>
</html>
   
